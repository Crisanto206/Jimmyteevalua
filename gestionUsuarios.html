<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Usuarios - AccessOne Checklist</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    h2 { color: #2E0060; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ddd; }
    th { background: #f0f0f0; text-align: left; }
    .actions button { margin-right: 5px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 500px; max-height: 90%; overflow-y: auto; }
    .checkbox-container { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; padding: 10px; margin-top: 5px; }
    .checkbox-container label { display: flex; align-items: center; margin-bottom: 8px; }
    .checkbox-container input { margin-right: 8px; }
    .close-btn { background: #ccc; color: #333; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
    .save-btn { background: #2E0060; color: #fff; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Gestión de Usuarios</h2>
    <p id="loadingMsg">Cargando usuarios…</p>
    <table id="usersTable" style="display:none;">
      <thead>
        <tr><th>Correo</th><th>Admin</th><th>Proyectos</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal de edición -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>Editar Usuario</h3>
      <p id="modalEmail"></p>
      <label><input type="checkbox" id="modalIsAdmin"/> Administrador</label>
      <label>Proyectos asignados</label>
      <div id="modalProjects" class="checkbox-container"></div>
      <div style="margin-top:20px; text-align:right;">
        <button class="close-btn">Cancelar</button>
        <button class="save-btn">Guardar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./js/firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { collection, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const loadingMsg = document.getElementById('loadingMsg');
    const usersTable = document.getElementById('usersTable');
    const tbody = usersTable.querySelector('tbody');
    const editModal = document.getElementById('editModal');
    const modalEmail = document.getElementById('modalEmail');
    const modalIsAdmin = document.getElementById('modalIsAdmin');
    const modalProjects = document.getElementById('modalProjects');
    const closeBtn = editModal.querySelector('.close-btn');
    const saveBtn = editModal.querySelector('.save-btn');

    let usersData = [];
    const ALL_PROJECTS = [
      "Adagio","Boulevard 5 de mayo","Buenavista","Centenario","Combo Aeropuerto",
      "Combo Azcapotzalco","Combo Carrizal","Combo Cuautitlán","Combo Satélite",
      "Comitán","Cuautitlán 1ero de mayo","Dorada I Dorada II","Galerías VHS",
      "Hermosillo","Insurgentes Nte.","Kómplex","La Raza","León","Tijuana",
      "Macroplaza Insurgentes Tijuana","Moroleon","Paroli","Patio Pedregal",
      "Portal Churubusco","San Manuel","Símbolos Patrios","Suburbia","Tacámbaro",
      "Tapachula","Tepeyac","Tlalpan","Tlaxcala","Uruapan","Vía San Ángel",
      "Zitácuaro","Playa del Carmen","Paseo Akia","WE Periferico","Pirules",
      "La Mangana","WE Horacio","Tacubaya","Mariano Escobedo","Ferrocarril Hidalgo",
      "Sam´s Oaxaca","Plaza Alamos","San Pedrito"
    ];

    function openModal(user) {
      modalEmail.textContent = user.email;
      modalIsAdmin.checked = !!user.isAdmin;
      modalProjects.innerHTML = '';
      const assigned = Array.isArray(user.assignedProjects) ? user.assignedProjects : [];
      ALL_PROJECTS.forEach(proj => {
        const lbl = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.value = proj;
        if (assigned.includes(proj)) cb.checked = true;
        lbl.appendChild(cb);
        lbl.appendChild(document.createTextNode(proj));
        modalProjects.appendChild(lbl);
      });
      editModal.style.display = 'flex';
      saveBtn.dataset.uid = user.id;
    }

    function closeModal() {
      editModal.style.display = 'none';
    }

    onAuthStateChanged(auth, async user => {
      if (!user) return window.location.href = 'login-admin.html';
      const adminSnap = await getDoc(doc(db, 'users', user.uid));
      if (!adminSnap.exists() || !adminSnap.data().isAdmin) return window.location.href = 'login-admin.html';

      const snapshot = await getDocs(collection(db, 'users'));
      usersData = snapshot.docs.map(d => {
        const data = d.data();
        return { id: d.id, email: data.email || '', isAdmin: data.isAdmin || false, assignedProjects: Array.isArray(data.assignedProjects) ? data.assignedProjects : [] };
      });
      loadingMsg.style.display = 'none';
      usersTable.style.display = 'table';
      usersData.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.email}</td>
          <td>${u.isAdmin}</td>
          <td>${u.assignedProjects.join(', ')}</td>
          <td class="actions"><button data-id="${u.id}">Editar</button></td>
        `;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button').forEach(btn => btn.addEventListener('click', e => {
        const uid = e.target.dataset.id;
        const userObj = usersData.find(u => u.id === uid);
        openModal(userObj);
      }));
    });

    closeBtn.addEventListener('click', closeModal);
    saveBtn.addEventListener('click', async () => {
      const uid = saveBtn.dataset.uid;
      const updated = {
        isAdmin: modalIsAdmin.checked,
        assignedProjects: Array.from(modalProjects.querySelectorAll('input:checked')).map(cb => cb.value)
      };
      await updateDoc(doc(db, 'users', uid), updated);
      closeModal();
      location.reload();
    });
  </script>
</body>
</html>

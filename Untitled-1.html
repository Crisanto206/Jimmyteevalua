<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gerente · Vacantes por Proyecto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #2E0060;
      --primary-700: #3a0077;
      --secondary: #FFD400;
      --bg: #f6f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --gray: #e5e7eb;
      --danger: #e03131;
      --warning: #ffb100;
      --success: #2eb67d;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg); color: #1f2937;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header {
      display: flex; align-items: center; gap: 14px;
      background: var(--card); padding: 14px 18px; border-radius: 12px;
      border-bottom: 4px solid var(--secondary);
      position: sticky; top: 0; z-index: 5;
    }
    header h1 { margin: 0; font-size: 1.35rem; color: var(--primary); letter-spacing: .3px; }
    #userBar { margin-left: auto; display: flex; align-items: center; gap: 8px; }
    #userBar .email { color: var(--primary); font-weight: 700; }
    #userBar button {
      background: var(--primary); color: #fff; border: 0; border-radius: 8px;
      padding: 8px 12px; font-weight: 800; cursor: pointer;
    }
    #userBar button:hover { background: var(--primary-700); }

    .grid {
      display: grid; grid-template-columns: 1.15fr 2fr; gap: 16px; margin-top: 16px;
    }
    .card {
      background: var(--card); border-radius: 12px; padding: 16px;
      box-shadow: 0 8px 20px rgba(34, 34, 34, .06);
    }
    .card h2 { margin: 0 0 10px; color: var(--primary); font-size: 1.05rem; }

    /* Formulario */
    .form-grid {
      display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto;
      gap: 10px; align-items: end;
    }
    label { font-weight: 700; color: var(--primary); font-size: .95rem; }
    input[type="text"], input[type="date"], select {
      width: 100%; margin-top: 6px; padding: 10px 12px; border-radius: 10px;
      border: 1px solid var(--gray); background: #fff; font-size: .95rem;
    }
    button.btn {
      background: var(--primary); color: #fff; border: 0; border-radius: 10px;
      padding: 12px 16px; font-weight: 900; cursor: pointer;
    }
    button.btn:hover { background: var(--primary-700); }

    /* KPIs */
    .kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .kpi {
      background: #fafafa; border: 1px solid var(--gray); border-radius: 12px;
      padding: 12px; text-align: center;
    }
    .kpi .value { font-size: 1.3rem; font-weight: 900; }
    .kpi small { display: block; color: var(--muted); margin-top: 4px; font-weight: 700; }

    /* Filtros */
    .filters { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .chip {
      border: 1px solid var(--primary); color: var(--primary);
      padding: 6px 10px; border-radius: 999px; font-weight: 700; cursor: pointer;
      user-select: none; font-size: .9rem; background: #fff;
    }
    .chip.active { background: var(--primary); color: #fff; }

    /* Timeline */
    .timeline { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
    .item {
      border: 1px solid var(--gray); border-radius: 12px; padding: 12px;
      display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;
      background: #fff;
    }
    .left .title { font-weight: 900; color: #111827; }
    .left .meta { color: var(--muted); font-size: .9rem; margin-top: 4px; }
    .badges { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
    .badge {
      padding: 4px 8px; border-radius: 999px; font-weight: 800; font-size: .8rem;
      border: 1px solid var(--gray); background: #f9fafb; color: #333;
    }
    .badge.role { border-color: var(--primary); color: var(--primary); background: #f6f0ff; }
    .badge.status.abierta { background: #ecfff6; border-color: var(--success); color: #086a42; }
    .badge.status.cerrada { background: #fff3f3; border-color: var(--danger); color: #7a1b1b; }
    .actions { display: flex; gap: 8px; }
    .btn-sm {
      border: 0; border-radius: 10px; padding: 8px 10px; font-weight: 800; cursor: pointer;
      background: #f3f4f6; color: #111827;
    }
    .btn-sm.close { background: #ffeaea; color: #7a1b1b; }
    .btn-sm.dup { background: #ededff; color: #2b2b6f; }

    /* Skeletons */
    .skeleton {
      height: 74px; border-radius: 12px; background: linear-gradient(90deg,#eee,#f6f6f6,#eee);
      background-size: 200% 100%; animation: shine 1.2s infinite linear;
      border: 1px solid var(--gray);
    }
    @keyframes shine { to { background-position: -200% 0; } }

    /* Toasts */
    .toasts {
      position: fixed; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 50;
    }
    .toast {
      background: #111827; color: #fff; padding: 10px 12px; border-radius: 10px; font-weight: 800;
      box-shadow: 0 10px 30px rgba(0,0,0,.15); display: flex; align-items: center; gap: 10px;
    }
    .toast.ok { background: #0f766e; }
    .toast.err { background: #7a1b1b; }
    .toast.warn { background: #b45309; }

    @media (max-width: 960px) {
      .grid { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .filters { grid-template-columns: 1fr 1fr; }
      .kpis { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="index.html"><img src="logo.jpg" alt="AccessOne Logo" style="height:44px;border-radius:10px;"></a>
      <h1>Gerente · Vacantes por Proyecto</h1>
      <div id="userBar"></div>
    </header>

    <div class="grid">
      <!-- Columna izquierda: formulario + KPIs + filtros -->
      <div class="card">
        <h2>Registrar vacante</h2>
        <form id="formVac" class="form-grid" autocomplete="off">
          <label>Proyecto
            <input type="text" id="project" list="projectList" placeholder="Escribe para filtrar..." required readonly
                   onfocus="this.removeAttribute('readonly');" onblur="this.setAttribute('readonly','readonly');" autocomplete="off">
            <datalist id="projectList"></datalist>
          </label>
          <label>Rol
            <select id="rol" required>
              <option value="">Selecciona…</option>
              <option>Operativo Matutino</option>
              <option>Operativo Vespertino</option>
              <option>Operativo Nocturno</option>
              <option>Supervisor</option>
              <option>Gerente</option>
            </select>
          </label>
          <label>Ticket
            <input type="text" id="ticket" maxlength="40" placeholder="Ej. MD-12345" required>
          </label>
          <label>Fecha
            <input type="date" id="fecha" required>
          </label>
          <button class="btn" type="submit">Registrar</button>
        </form>

        <hr style="margin:14px 0">

        <h2>KPIs del proyecto</h2>
        <div class="kpis" id="kpis">
          <div class="kpi"><div class="value" id="kpiTotal">0</div><small>Vacantes abiertas</small></div>
          <div class="kpi"><div class="value" id="kpiMat">0</div><small>Operativo Matutino</small></div>
          <div class="kpi"><div class="value" id="kpiVes">0</div><small>Operativo Vespertino</small></div>
          <div class="kpi"><div class="value" id="kpiNoc">0</div><small>Operativo Nocturno</small></div>
        </div>

        <div class="chips" id="roleChips" style="margin-top:10px;">
          <div class="chip active" data-role="ALL">Todos</div>
          <div class="chip" data-role="Operativo Matutino">Op. Matutino</div>
          <div class="chip" data-role="Operativo Vespertino">Op. Vespertino</div>
          <div class="chip" data-role="Operativo Nocturno">Op. Nocturno</div>
          <div class="chip" data-role="Supervisor">Supervisor</div>
          <div class="chip" data-role="Gerente">Gerente</div>
        </div>

        <div class="filters">
          <label>Desde<input type="date" id="fDesde"></label>
          <label>Hasta<input type="date" id="fHasta"></label>
          <label>Buscar ticket<input type="text" id="fBusca" placeholder="MD-123…"></label>
          <label>Estado
            <select id="fEstado">
              <option value="ALL">Todos</option>
              <option value="Abierta">Abierta</option>
              <option value="Cerrada">Cerrada</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Columna derecha: timeline -->
      <div class="card">
        <h2>Vacantes registradas</h2>
        <div id="list" class="timeline">
          <div class="skeleton"></div>
          <div class="skeleton"></div>
          <div class="skeleton"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toasts" id="toasts"></div>

  <script type="module">
    // Firebase (igual que checklist)
    import { auth, db } from "./js/firebase-config.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { doc, getDoc, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Estado
    let currentUser = null;
    let userProjects = [];
    let currentProject = "";
    let vacantesCache = []; // del proyecto actual
    let filters = { role: "ALL", desde: "", hasta: "", busca: "", estado: "ALL" };

    // DOM helpers
    const $ = s => document.querySelector(s);
    const el = (tag, attrs = {}, ...children) => {
      const n = document.createElement(tag);
      Object.entries(attrs || {}).forEach(([k, v]) => {
        if (k === "class") n.className = v;
        else if (k in n) n[k] = v;
        else n.setAttribute(k, v);
      });
      children.forEach(c => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
      return n;
    };

    // Toasts
    function toast(msg, type="ok") {
      const box = $("#toasts");
      const t = el("div", { class: `toast ${type}` }, msg);
      box.appendChild(t);
      setTimeout(()=> { t.style.opacity="0"; t.style.transform="translateY(-6px)"; }, 2800);
      setTimeout(()=> t.remove(), 3400);
    }

    // Fecha MX por defecto
    function todayMx() {
      const now = new Date();
      const mx = new Date(now.toLocaleString('en-US', { timeZone: 'America/Mexico_City' }));
      const y = mx.getFullYear(), m = String(mx.getMonth()+1).padStart(2,'0'), d = String(mx.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    // Auth + carga inicial (mismo patrón que checklist)
    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = "login.html"; return; }
      currentUser = user;
      renderUserBar(user);

      try {
        const u = await getDoc(doc(db, "users", user.uid));
        if (!u.exists()) throw new Error("Sin permisos");
        userProjects = Array.isArray(u.data().assignedProjects) ? u.data().assignedProjects : [];
        if (!userProjects.length) throw new Error("Sin proyectos asignados");

        buildProjectList();
        // Autoselección si hay uno
        if (userProjects.length === 1) {
          $("#project").value = userProjects[0];
          currentProject = userProjects[0];
        }
        // Fecha default
        $("#fecha").value = todayMx();

        attachEvents();
        await refreshProjectData();
      } catch (err) {
        console.error(err);
        alert("No tienes permisos configurados. Contacta al administrador.");
        window.location.href = "login.html";
      }
    });

    function renderUserBar(user) {
      const bar = $("#userBar"); bar.innerHTML = "";
      bar.append(
        el("span", { class: "email" }, user.email || ""),
        el("button", { onclick: async () => { try { await signOut(auth); window.location.href="login.html"; } catch(e){ toast("No se pudo cerrar sesión","err"); } }}, "Cerrar sesión")
      );
    }

    function buildProjectList() {
      const dl = $("#projectList"); dl.innerHTML = "";
      userProjects.forEach(p => dl.appendChild(el("option", { value: p })));
    }

    function attachEvents() {
      // Selección de proyecto
      $("#project").addEventListener("change", async (e) => {
        const p = e.target.value.trim();
        if (!userProjects.includes(p)) { toast("Proyecto no permitido","err"); $("#project").value = ""; return; }
        currentProject = p;
        await refreshProjectData();
      });

      // Chips de rol
      $("#roleChips").addEventListener("click", (e) => {
        const chip = e.target.closest(".chip"); if (!chip) return;
        $("#roleChips").querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        filters.role = chip.dataset.role || "ALL";
        renderList();
      });

      // Filtros
      $("#fDesde").addEventListener("change", e => { filters.desde = e.target.value || ""; renderList(); });
      $("#fHasta").addEventListener("change", e => { filters.hasta = e.target.value || ""; renderList(); });
      $("#fBusca").addEventListener("input", e => { filters.busca = (e.target.value||"").toLowerCase(); renderList(); });
      $("#fEstado").addEventListener("change", e => { filters.estado = e.target.value; renderList(); });

      // Registrar vacante
      $("#formVac").addEventListener("submit", onRegister);
    }

    async function refreshProjectData() {
      // skeletons
      const list = $("#list");
      list.innerHTML = ""; for (let i=0;i<3;i++) list.appendChild(el("div",{class:"skeleton"}));

      if (!currentProject) { vacantesCache = []; renderList(); return; }

      try {
        const ref = doc(db, "project_scores", currentProject);
        const snap = await getDoc(ref);
        vacantesCache = (snap.exists() && Array.isArray(snap.data().vacantes)) ? snap.data().vacantes : [];
      } catch (err) {
        console.error(err);
        vacantesCache = [];
        toast("No se pudieron cargar vacantes","err");
      }
      renderList();
    }

    async function onRegister(e) {
      e.preventDefault();
      const p = $("#project").value.trim();
      const rol = $("#rol").value.trim();
      const ticket = $("#ticket").value.trim();
      const fecha = $("#fecha").value;

      if (!p || !userProjects.includes(p)) return toast("Proyecto inválido","err");
      if (!rol) return toast("Selecciona un rol","warn");
      if (!ticket) return toast("Ingresa ticket","warn");
      if (!fecha) return toast("Selecciona fecha","warn");

      const entry = {
        project: p,
        role: rol,
        ticket,
        fecha,                     // YYYY-MM-DD
        user: currentUser.email || "",
        at: Timestamp.now(),
        status: "Abierta"
      };

      try {
        const ref = doc(db, "project_scores", p);
        const snap = await getDoc(ref);
        let vac = [];
        if (snap.exists() && Array.isArray(snap.data().vacantes)) vac = snap.data().vacantes;
        vac.unshift(entry);
        if (vac.length > 300) vac = vac.slice(0,300);
        await setDoc(ref, { vacantes: vac, vacantesLastUpdate: Timestamp.now() }, { merge: true });

        // UI
        toast("Vacante registrada");
        $("#ticket").value = "";
        $("#rol").selectedIndex = 0;
        $("#fecha").value = todayMx();
        // refrescamos cache/lista
        vacantesCache = vac;
        renderList(true);
      } catch (err) {
        console.error(err);
        toast("Error registrando la vacante","err");
      }
    }

    // Acciones item
    async function closeVacante(idx) {
      const p = currentProject; if (!p) return;
      const ref = doc(db, "project_scores", p);
      try {
        const snap = await getDoc(ref);
        let vac = (snap.exists() && Array.isArray(snap.data().vacantes)) ? snap.data().vacantes : [];
        if (!vac[idx]) return;
        vac[idx] = { ...vac[idx], status: "Cerrada" };
        await setDoc(ref, { vacantes: vac, vacantesLastUpdate: Timestamp.now() }, { merge: true });
        toast("Vacante cerrada");
        vacantesCache = vac;
        renderList();
      } catch (err) {
        console.error(err);
        toast("No se pudo cerrar","err");
      }
    }

    async function duplicateVacante(idx) {
      const p = currentProject; if (!p) return;
      const ref = doc(db, "project_scores", p);
      try {
        const snap = await getDoc(ref);
        let vac = (snap.exists() && Array.isArray(snap.data().vacantes)) ? snap.data().vacantes : [];
        if (!vac[idx]) return;
        const base = vac[idx];
        const copy = {
          ...base,
          fecha: todayMx(),
          at: Timestamp.now(),
          status: "Abierta",
          ticket: base.ticket + "-D" // simple marca para distinguir
        };
        vac.unshift(copy);
        if (vac.length > 300) vac = vac.slice(0,300);
        await setDoc(ref, { vacantes: vac, vacantesLastUpdate: Timestamp.now() }, { merge: true });
        toast("Vacante duplicada");
        vacantesCache = vac;
        renderList(true);
      } catch (err) {
        console.error(err);
        toast("No se pudo duplicar","err");
      }
    }

    // Render
    function renderList(scrollTop=false) {
      // KPIs
      const abiertas = vacantesCache.filter(v => v.status !== "Cerrada");
      $("#kpiTotal").textContent = abiertas.length;
      $("#kpiMat").textContent = abiertas.filter(v => v.role === "Operativo Matutino").length;
      $("#kpiVes").textContent = abiertas.filter(v => v.role === "Operativo Vespertino").length;
      $("#kpiNoc").textContent = abiertas.filter(v => v.role === "Operativo Nocturno").length;

      const list = $("#list"); list.innerHTML = "";

      // Aplicar filtros
      const f = vacantesCache.filter(v => {
        if (filters.role !== "ALL" && v.role !== filters.role) return false;
        if (filters.estado !== "ALL" && (v.status||"Abierta") !== filters.estado) return false;
        if (filters.busca && !(String(v.ticket||"").toLowerCase().includes(filters.busca))) return false;
        if (filters.desde && v.fecha && v.fecha < filters.desde) return false;
        if (filters.hasta && v.fecha && v.fecha > filters.hasta) return false;
        return true;
      });

      if (!f.length) {
        list.appendChild(el("div", { class:"item" },
          el("div", { class:"left" },
            el("div", { class:"title" }, "Sin resultados"),
            el("div", { class:"meta" }, "Ajusta filtros o registra nuevas vacantes.")
          )
        ));
        return;
      }

      f.slice(0,60).forEach((v, i) => {
        const idx = vacantesCache.indexOf(v); // índice real en el arreglo para acciones
        const edad = diasDesde(v.fecha);

        const left = el("div", { class:"left" },
          el("div", { class:"title" }, `${v.ticket || "Sin ticket"}`),
          el("div", { class:"meta" }, `${v.fecha || "s/fecha"} · ${edad} día(s) · ${v.user || ""}`),
          el("div", { class:"badges" },
            chip("role", v.role || "-"),
            chipStatus(v.status || "Abierta"),
            edadBadge(edad)
          )
        );

        const actions = el("div", { class:"actions" },
          el("button", { class:"btn-sm close", title:"Cerrar", onclick: () => closeVacante(idx) }, "Cerrar"),
          el("button", { class:"btn-sm dup", title:"Duplicar", onclick: () => duplicateVacante(idx) }, "Duplicar")
        );

        list.appendChild(el("div", { class:"item" }, left, actions));
      });

      if (scrollTop) list.scrollTo({ top: 0, behavior: "smooth" });
    }

    function chip(kind, txt) {
      const d = el("span", { class:"badge role" }, txt);
      return d;
    }
    function chipStatus(st) {
      const c = (st.toLowerCase() === "cerrada") ? "cerrada" : "abierta";
      return el("span", { class:`badge status ${c}` }, st);
    }
    function edadBadge(dias) {
      let cls = "badge";
      if (dias >= 14) cls += " status cerrada"; // rojo visual (urgente)
      else if (dias >= 7) cls += " status abierta"; // verde pálido como ámbar suave
      return el("span", { class: cls }, `${dias} d`);
    }
    function diasDesde(yyyy_mm_dd) {
      if (!yyyy_mm_dd) return 0;
      const f = new Date(yyyy_mm_dd + "T00:00:00");
      const hoy = new Date();
      return Math.max(0, Math.floor((hoy - f) / (1000*60*60*24)));
    }
  </script>
</body>
</html>

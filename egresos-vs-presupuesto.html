<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Egresos vs Presupuesto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body {
      background: linear-gradient(120deg, #e0e3e8 0%, #f4f6fa 100%);
      font-family: 'Montserrat', Arial, sans-serif;
      color: #1B1F3B;
      margin: 0;
      min-height: 100vh;
      padding: 0;
      letter-spacing: 0.01em;
      overflow-x: hidden;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 2vw;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 18px;
    }
    .header h1 {
      font-size: 2em;
      font-weight: 900;
      color: #FFD400;
      margin: 0;
      letter-spacing: 1.5px;
      text-shadow: 0 4px 16px rgba(27,31,59,0.10);
    }
    .controls {
      display: flex;
      gap: 18px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }
    .controls label {
      font-weight: 700;
      color: #1B1F3B;
      margin-right: 6px;
      font-size: 1em;
    }
    .controls select, .controls input[type="file"] {
      font-size: 1em;
      padding: 7px 12px;
      border-radius: 6px;
      border: 2px solid #00B2A9;
      background: #fff;
      color: #1B1F3B;
      font-weight: 600;
      margin-right: 10px;
      box-shadow: 0 2px 8px rgba(27,31,59,0.08);
      transition: border 0.18s, box-shadow 0.18s;
      cursor: pointer;
      min-width: 90px;
    }
    .controls select:focus, .controls input[type="file"]:focus {
      border: 2.5px solid #FFD400;
      box-shadow: 0 0 0 2px #00B2A9;
    }
    .main {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      justify-content: space-between;
      width: 100%;
      min-width: 0;
      box-sizing: border-box;
    }
    .chart-area, .table-area {
      flex: 1 1 0;
      min-width: 0;
      background: rgba(255,255,255,0.92);
      border-radius: 14px;
      box-shadow: 0 4px 16px rgba(27,31,59,0.12);
      padding: 18px 2vw 14px 2vw;
      margin-bottom: 18px;
      border: 1px solid #e0e3e8;
      overflow-x: auto;
      max-width: 100%;
      box-sizing: border-box;
      width: 100%;
    }
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: max-content;
      min-width: 700px;
      margin: 0;
      table-layout: auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(27,31,59,0.08);
      overflow: hidden;
      font-size: 1em;
      letter-spacing: 0.01em;
    }
    th, td {
      border: 1px solid #e0e3e8;
      padding: 10px 7px;
      vertical-align: top;
      font-size: 0.98em;
      text-align: right;
      min-width: 90px;
      max-width: 180px;
      word-break: break-word;
      transition: background 0.18s, color 0.18s;
    }
    th {
      background: linear-gradient(90deg, #1B1F3B 80%, #00B2A9 100%);
      color: #fff;
      font-size: 1em;
      border: none;
      text-align: center;
      font-weight: 900;
      position: sticky;
      top: 0;
      z-index: 2;
      letter-spacing: 0.02em;
      box-shadow: 0 2px 8px rgba(27,31,59,0.10);
    }
    td:first-child, th:first-child {
      text-align: left;
      font-weight: 700;
      background: linear-gradient(135deg, #f4f6fa 0%, #e0e3e8 100%);
      color: #1B1F3B;
      min-width: 160px;
      max-width: 240px;
      font-size: 1em;
      letter-spacing: 0.01em;
    }
    tr:nth-child(even) td {
      background: #f5f6fa;
    }
    tr:hover td {
      background: #FFD400;
      color: #1B1F3B;
      transition: background 0.18s, color 0.18s;
    }
    tr td:last-child {
      font-weight: 900;
      font-size: 1em;
      border-left: 4px solid #00B2A9;
    }
    .btn {
      display: inline-block;
      padding: 10px 22px;
      font-size: 1em;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(90deg, #1B1F3B 70%, #00B2A9 100%);
      border: none;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(27,31,59,0.08);
      cursor: pointer;
      transition: background 0.18s, box-shadow 0.18s;
      margin-right: 8px;
      letter-spacing: 0.01em;
    }
    .btn:hover, .btn:focus {
      background: linear-gradient(90deg, #00B2A9 70%, #1B1F3B 100%);
      box-shadow: 0 4px 16px rgba(27,31,59,0.18);
    }
    @media (max-width: 900px) {
      .main { flex-direction: column; gap: 14px; }
      .chart-area, .table-area { min-width: 0; width: 100%; }
      .header { flex-direction: column; gap: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Egresos vs Presupuesto</h1>
    </div>
    <div class="controls">
      <label>Archivo Excel:</label>
      <input type="file" id="input-excel" accept=".xlsx,.xls" />
      <label>Mes:</label>
      <select id="filtro-mes"><option value="todos">Todos</option></select>
      <label>Ordenar:</label>
      <select id="filtro-orden">
        <option value="desc">Mayor a menor</option>
        <option value="asc">Menor a mayor</option>
      </select>
    </div>
    <div class="main">
      <div class="table-area" style="flex:2 1 0; min-width:0; width:100%;">
        <table id="tabla-comparativo"></table>
      </div>
    </div>
  </div>
  <script type="module">
    let excelData = [];
    let meses = [];
    let partidas = [];
    let selectedMes = "todos";
    let filtroOrden = "desc";

    document.getElementById("input-excel").addEventListener("change", handleExcel, false);
    document.getElementById("filtro-mes").addEventListener("change", e => {
      selectedMes = e.target.value;
      renderComparativo();
    });
    document.getElementById("filtro-orden").addEventListener("change", e => {
      filtroOrden = e.target.value;
      renderComparativo();
    });

    function handleExcel(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        excelData = XLSX.utils.sheet_to_json(sheet, {header:1});
        parseExcelData();
      };
      reader.readAsArrayBuffer(file);
    }

    function parseExcelData() {
      // Encuentra encabezados y meses
      let headerRow = excelData.find(row => row.includes('egresos') && row.includes('presup_e'));
      if (!headerRow) return;
      let headerIdx = excelData.indexOf(headerRow);
      let egresosIdx = headerRow.findIndex(h => h && h.toString().toLowerCase().includes('egresos'));
      let presupIdx = headerRow.findIndex(h => h && h.toString().toLowerCase().includes('presup'));
      let difeIdx = headerRow.findIndex(h => h && h.toString().toLowerCase().includes('dife'));
      let nivelIdx = headerRow.findIndex(h => h && h.toString().toLowerCase().includes('nivel'));
      // Detecta meses (solo nombres exactos de mes)
      meses = [];
      for (let i = headerIdx+1; i < excelData.length; i++) {
        let row = excelData[i];
        if (!row || !row[nivelIdx]) continue;
        let nivel = row[nivelIdx].toString().trim();
        // Solo cuenta si es exactamente el nombre del mes (no subtotales, no espacios)
        if (/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)$/i.test(nivel)) {
          meses.push({name: nivel, idx: i});
        }
      }
      // Llena select de meses
      const mesSel = document.getElementById("filtro-mes");
      mesSel.innerHTML = `<option value="todos">Todos</option>` + meses.map(m => `<option value="${m.name}">${m.name.charAt(0).toUpperCase()+m.name.slice(1)}</option>`).join("");
      // Extrae partidas
      partidas = [];
      let currentMes = "";
      for (let i = headerIdx+1; i < excelData.length; i++) {
        let row = excelData[i];
        if (!row || !row[nivelIdx]) continue;
        let nivel = row[nivelIdx].toString().trim();
        // Detecta mes exacto (no subtotales ni año)
        if (/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)$/i.test(nivel)) {
          currentMes = nivel;
          continue;
        }
        // Excluye subtotales y filas de año
        if (/^subtotales/i.test(nivel) || /^\d{4}$/.test(nivel)) continue;
        // Solo partidas con código de 10 dígitos al inicio
        if (/^\d{10}/.test(nivel)) {
          partidas.push({
            nivel: nivel,
            egresos: parseFloat(row[egresosIdx]) || 0,
            presup: parseFloat(row[presupIdx]) || 0,
            dife: parseFloat(row[difeIdx]) || 0,
            mes: currentMes
          });
        }
      }
      renderComparativo();
    }

    function renderComparativo() {
      if (!partidas.length) return;
      let data = partidas;
      if (selectedMes !== "todos") {
        data = data.filter(p => p.mes && p.mes.trim().toLowerCase() === selectedMes.trim().toLowerCase());
      }
      let labels = data.map(p => p.nivel);
      let egresos = data.map(p => p.egresos);
      let presup = data.map(p => p.presup);
      let diffs = data.map(p => p.presup - p.egresos);
      // Ordenar
      let idxs = labels.map((_,i)=>i);
      idxs.sort((i,j) => filtroOrden==="desc" ? diffs[j]-diffs[i] : diffs[i]-diffs[j]);
      labels = idxs.map(i=>labels[i]);
      egresos = idxs.map(i=>egresos[i]);
      presup = idxs.map(i=>presup[i]);
      diffs = idxs.map(i=>diffs[i]);
      renderTable(labels, egresos, presup, diffs);
    }

    function renderTable(labels, egresos, presup, diffs) {
      const table = document.getElementById("tabla-comparativo");
      let header = `<tr><th>Partida</th><th>Egresos</th><th>Presupuesto</th><th>Diferencia</th></tr>`;
      let rows = labels.map((label, i) => {
        let diffColor = diffs[i] >= 0 ? "#00C48C" : "#FF4D4F";
        return `<tr><td>${label}</td><td>$ ${egresos[i].toLocaleString("es-MX", {minimumFractionDigits:2})}</td><td>$ ${presup[i].toLocaleString("es-MX", {minimumFractionDigits:2})}</td><td style="color:${diffColor}; font-weight:700;">$ ${diffs[i].toLocaleString("es-MX", {minimumFractionDigits:2})}</td></tr>`;
      }).join("");
      table.innerHTML = `<thead>${header}</thead><tbody>${rows}</tbody>`;
    }
  </script>
</body>
</html>
            {
              label: "Egresos",
              data: egresos,
              backgroundColor: "#FF4D4F",
              borderRadius: 8,
              borderSkipped: false
            },
            {
              label: "Presupuesto",
              data: presup,
              backgroundColor: "#FFD400",
              borderRadius: 8,
              borderSkipped: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            title: {
              display: true,
              text: "Egresos vs Presupuesto",
              color: "#1B1F3B",
              font: { size: 22, weight: "bold" }
            },
            tooltip: {
              callbacks: {
                label: ctx => {
                  return "$ " + ctx.raw.toLocaleString("es-MX", {minimumFractionDigits:2});
                }
              }
            }
          },
          animation: {
            duration: 900,
            easing: "easeOutBounce"
          },
          scales: {
            x: {
              ticks: { color: "#1B1F3B", font: { weight: "bold" } },
              grid: { color: "#e0e3e8" }
            },
            y: {
              beginAtZero: true,
              ticks: { color: "#1B1F3B", font: { weight: "bold" } },
              grid: { color: "#e0e3e8" }
            }
          }
        }
      });
    }

    function renderTable(labels, egresos, presup, diffs) {
      const table = document.getElementById("tabla-comparativo");
      let header = `<tr><th>Partida</th><th>Egresos</th><th>Presupuesto</th><th>Diferencia</th></tr>`;
      let rows = labels.map((label, i) => {
        let diffColor = diffs[i] >= 0 ? "#00C48C" : "#FF4D4F";
        return `<tr><td>${label}</td><td>$ ${egresos[i].toLocaleString("es-MX", {minimumFractionDigits:2})}</td><td>$ ${presup[i].toLocaleString("es-MX", {minimumFractionDigits:2})}</td><td style="color:${diffColor}; font-weight:700;">$ ${diffs[i].toLocaleString("es-MX", {minimumFractionDigits:2})}</td></tr>`;
      }).join("");
      table.innerHTML = `<thead>${header}</thead><tbody>${rows}</tbody>`;
    }
  </script>
</body>
</html>

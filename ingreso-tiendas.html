<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ingreso de Proyectos - AccessOne</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .card {
      background: var(--bg-white);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(46,0,96,0.12);
      padding: 48px 36px 36px 36px;
      margin-top: -32px;
      border: none;
      animation: fadeInCard 0.7s cubic-bezier(.4,0,.2,1);
      transition: box-shadow 0.25s, transform 0.18s;
    }
    
    @keyframes fadeInCard {
      from { opacity: 0; transform: translateY(40px);}
      to { opacity: 1; transform: none;}
    }
    
    .card:hover {
      box-shadow: 0 12px 40px #FFD40033, 0 2px 0 #00B2A9;
      transform: translateY(-2px) scale(1.01);
    }
    
    .form-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      background: #fafafa;
    }
    
    .form-section h3 {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 1.3em;
    }
    
    .input-group {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
    }
    
    .input-group label {
      min-width: 150px;
      font-weight: 600;
      color: var(--primary);
    }
    
    .input-group input {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .input-group input:focus {
      border-color: var(--accent);
      outline: none;
      background: #fffbe7;
    }
    
    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
    }
    
    .btn:hover {
      background: linear-gradient(90deg, #FFD400 60%, #00B2A9 100%);
      transform: scale(1.04);
      box-shadow: 0 4px 16px #FFD40033;
    }
    
    .btn-success {
      background: #28a745;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 600;
    }
    
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .progress-container {
      background: #e0e0e0;
      border-radius: 10px;
      height: 20px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
      height: 100%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
    }
    
    .bulk-upload {
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      margin: 20px 0;
    }
    
    .tienda-preview {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .tienda-info {
      flex: 1;
    }
    
    .tienda-info strong {
      color: var(--primary);
    }
    
    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    #logoutBtn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    #logoutBtn:hover {
      background: #5a6268;
      transform: scale(1.02);
    }
  </style>
</head>
<body>
  <!-- Header igual que en checklist -->
  <header>
    <div class="header-content">
      <div class="header-logo">
        <img id="logo-accessone" src="logo.png" alt="AccessOne" class="logo">
        <span class="header-title">AccessOne</span>
      </div>
      <nav class="header-nav">
        <div class="user-info">
          <span id="user-email"></span>
        </div>
      </nav>
    </div>
  </header>

  <main class="main-content">
    <div class="card">
      <div class="form-header">
        <h1>Ingreso de Correspondencia de Proyectos</h1>
        <button id="logoutBtn">Cerrar Sesi√≥n</button>
      </div>

      <!-- Formulario individual -->
      <div class="form-section">
        <h3>Agregar Proyecto Individual</h3>
        <div class="input-group">
          <label for="checklistName">Nombre Checklist:</label>
          <input type="text" id="checklistName" placeholder="Ej: Combo Azcapotzalco">
        </div>
        <div class="input-group">
          <label for="saiName">Nombre en SAI:</label>
          <input type="text" id="saiName" placeholder="Ej: walmart azcapotzalco">
        </div>
        <button class="btn" onclick="agregarProyectoIndividual()">Agregar Proyecto</button>
      </div>

      <!-- Carga masiva -->
      <div class="form-section">
        <h3>Carga Masiva de Proyectos</h3>
        <div class="bulk-upload">
          <p><strong>Formato:</strong> Pega el texto con formato "Nombre Checklist [TAB] Nombre SAI", una l√≠nea por proyecto</p>
          <textarea id="bulkData" rows="10" cols="80" placeholder="Combo Azcapotzalco	walmart azcapotzalco
Adagio	ADAGIO
Boulevard 5 de mayo	BLVD 5 DE MAYO
..."></textarea>
          <br><br>
          <button class="btn btn-success" onclick="procesarCargaMasiva()">Procesar Carga Masiva</button>
        </div>
      </div>

      <!-- Barra de progreso -->
      <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar">0%</div>
      </div>

      <!-- Mensajes de estado -->
      <div id="statusMessage"></div>

      <!-- Previsualizaci√≥n -->
      <div class="form-section" id="previewSection" style="display: none;">
        <h3>Vista Previa de Proyectos a Cargar</h3>
        <div id="previewContainer"></div>
        <button class="btn btn-success" onclick="confirmarCarga()">Confirmar y Cargar Todo</button>
        <button class="btn btn-danger" onclick="cancelarCarga()">Cancelar</button>
      </div>

      <!-- Botones de utilidad -->
      <div class="form-section">
        <h3>Utilidades</h3>
        <button class="btn" onclick="verDatosActuales()">Ver Datos Actuales</button>
        <button class="btn" onclick="probarPermisos()">üîß Probar Permisos Firebase</button>
        <button class="btn" onclick="cargarDatosPredefinidos()">Cargar Datos de Ejemplo</button>
        <button class="btn" onclick="exportarDatos()">Exportar Datos Actuales</button>
        <button class="btn btn-danger" onclick="limpiarTodosLosDatos()">Limpiar Todos los Datos</button>
      </div>

      <!-- Visualizaci√≥n de datos actuales -->
      <div class="form-section" id="datosActualesSection" style="display: none;">
        <h3>Datos Actuales en Firebase</h3>
        <div id="datosActualesContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: white;"></div>
      </div>
    </div>
  </main>

  <!-- Audio para feedback -->
  <audio id="keySound" preload="auto">
    <source src="key.mp3" type="audio/mpeg">
  </audio>

  <script type="module">
    // Importar Firebase
    import { auth, db } from "./js/firebase-config.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { doc, getDoc, setDoc, updateDoc, arrayUnion, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    let currentUser = null;
    let proyectosParaCargar = [];

    // Verificar autenticaci√≥n
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        document.getElementById("user-email").textContent = user.email;
        
        // Verificar permisos y mostrar advertencia si no es admin
        const email = user.email.toLowerCase();
        const adminEmails = [
          "csalcala@accessone.com.mx",
          "valonzo@accessone.com.mx", 
          "jfernandez@accessone.com.mx"
        ];
        
        if (!adminEmails.includes(email)) {
          mostrarMensaje('‚ö†Ô∏è Solo los administradores pueden modificar los datos de proyectos. Tu usuario tiene permisos de solo lectura.', 'error');
          
          // Deshabilitar botones de edici√≥n
          const botonesEdicion = ['agregarProyectoIndividual', 'procesarCargaMasiva', 'confirmarCarga', 'cargarDatosPredefinidos', 'limpiarTodosLosDatos'];
          botonesEdicion.forEach(btnId => {
            const btn = document.querySelector(`[onclick="${btnId}()"]`);
            if (btn) {
              btn.disabled = true;
              btn.style.opacity = '0.5';
              btn.title = 'Solo administradores pueden usar esta funci√≥n';
            }
          });
        }
      } else {
        window.location.href = "login.html";
      }
    });

    // Funciones globales
    window.agregarProyectoIndividual = async function() {
      const checklistName = document.getElementById('checklistName').value.trim();
      const saiName = document.getElementById('saiName').value.trim();
      
      if (!checklistName || !saiName) {
        mostrarMensaje('Por favor completa ambos campos', 'error');
        return;
      }

      try {
        await guardarProyecto(checklistName, saiName);
        mostrarMensaje(`Proyecto "${checklistName}" agregado correctamente`, 'success');
        
        // Limpiar campos
        document.getElementById('checklistName').value = '';
        document.getElementById('saiName').value = '';
        
        playKeySound();
      } catch (error) {
        console.error('Error al agregar proyecto:', error);
        mostrarMensaje('Error al agregar el proyecto: ' + error.message, 'error');
      }
    };

    window.procesarCargaMasiva = function() {
      const bulkData = document.getElementById('bulkData').value.trim();
      
      if (!bulkData) {
        mostrarMensaje('Por favor ingresa los datos para cargar', 'error');
        return;
      }

      const lineas = bulkData.split('\n');
      proyectosParaCargar = [];
      
      lineas.forEach((linea, index) => {
        const lineaTrim = linea.trim();
        if (lineaTrim) {
          // Separar por tabulaci√≥n o m√∫ltiples espacios
          const partes = lineaTrim.split(/\t+|\s{2,}/);
          
          if (partes.length >= 2) {
            proyectosParaCargar.push({
              checklist: partes[0].trim(),
              sai: partes[1].trim()
            });
          } else {
            console.warn(`L√≠nea ${index + 1} no tiene el formato correcto: ${lineaTrim}`);
          }
        }
      });
      
      if (proyectosParaCargar.length === 0) {
        mostrarMensaje('No se encontraron proyectos v√°lidos en el formato correcto', 'error');
        return;
      }
      
      mostrarVistaPrevia();
      playKeySound();
    };

    window.confirmarCarga = async function() {
      if (proyectosParaCargar.length === 0) return;
      
      mostrarProgreso(true);
      
      try {
        for (let i = 0; i < proyectosParaCargar.length; i++) {
          const proyecto = proyectosParaCargar[i];
          await guardarProyecto(proyecto.checklist, proyecto.sai);
          
          const progreso = ((i + 1) / proyectosParaCargar.length) * 100;
          actualizarProgreso(progreso);
          
          // Peque√±a pausa para evitar sobrecarga
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        mostrarMensaje(`Se cargaron ${proyectosParaCargar.length} proyectos correctamente`, 'success');
        
        // Limpiar
        document.getElementById('bulkData').value = '';
        proyectosParaCargar = [];
        document.getElementById('previewSection').style.display = 'none';
        
      } catch (error) {
        console.error('Error en carga masiva:', error);
        mostrarMensaje('Error durante la carga masiva: ' + error.message, 'error');
      } finally {
        mostrarProgreso(false);
      }
    };

    window.cancelarCarga = function() {
      proyectosParaCargar = [];
      document.getElementById('previewSection').style.display = 'none';
      mostrarMensaje('Carga cancelada', 'error');
    };

    window.cargarDatosPredefinidos = function() {
      const datosPredefinidos = `Combo Azcapotzalco	walmart azcapotzalco
Adagio	ADAGIO
Boulevard 5 de mayo	BLVD 5 DE MAYO
Buenavista	W. BUENAVISTA
Centenario	CENTENARIO
Combo Aeropuerto	MOROLEON
Combo Carrizal	CARRIZAL
Combo Cuautitl√°n	COMBO CUAUTITLAN
Combo Sat√©lite	walmart satelite
Comit√°n	W. COMITAN
Cuautitl√°n 1ero de mayo	SAMS CUAUTITLAN
Dorada I	DORADA 1
Dorada II	DORADA 2
Ferrocarril Hidalgo	BA FERROCARRIL HIDALGO
Galer√≠as VHS	VILLAHERMOSA
Hermosillo	HERMOSILLO
Insurgentes Nte.	BA INSURGENTES NORTE
La Mangana	LA MANGANA
La Raza	LA RAZA
Le√≥n	C. LEON
Macroplaza Insurgentes Tijuana	MACRO TIJUANA
Mariano Escobedo	BA MARIANO ESCOBEDO
Moroleon	MOROLEON
Paroli	PAROLI
Paseo Akia	PASEO AKIA
Patio Pedregal	PATIO PEDREGAL
Pirules	WALMART PIRULES
Playa del Carmen	PLAYA DEL CARMEN
Plaza Alamos	LOS ALAMOS
Portal Churubusco	PORTAL CHURUBUSCO
Sam¬¥s Oaxaca	SAMS CLUB OAXACA
San Manuel	SAN MANUEL
San Pedrito	BA SAN PEDRITO
S√≠mbolos Patrios	SIMBOLOS PATRIOS
Suburbia	SUB. MORELIA
Tac√°mbaro	TACAMBARO
Tacubaya	BA TACUBAYA
Tapachula	TAPACHULA
Tepeyac	PLAZA TEPEYAC
Tlalpan	TLALPAN
Tlaxcala	A5 TLAXCALA
Uruapan	URUAPAN
V√≠a San √Ångel	VIA SAN ANGEL
WE Horacio	WE HORACIO
WE Periferico	WE PERIFERICO
Zit√°cuaro	ZITACUARO
Apatzingan	BA APATZINGAN`;
      
      document.getElementById('bulkData').value = datosPredefinidos;
      mostrarMensaje('Datos predefinidos cargados en el √°rea de texto', 'success');
    };

    window.exportarDatos = async function() {
      try {
        const ref = doc(db, "tiendas_correspondencia", "mapping");
        const snap = await getDoc(ref);
        
        if (snap.exists()) {
          const data = snap.data();
          const exportText = Object.entries(data).map(([key, value]) => `${key}\t${value}`).join('\n');
          
          // Crear archivo para descarga
          const blob = new Blob([exportText], { type: 'text/plain' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'tiendas_correspondencia.txt';
          a.click();
          window.URL.revokeObjectURL(url);
          
          mostrarMensaje('Datos exportados correctamente', 'success');
        } else {
          mostrarMensaje('No hay datos para exportar', 'error');
        }
      } catch (error) {
        console.error('Error al exportar:', error);
        mostrarMensaje('Error al exportar datos: ' + error.message, 'error');
      }
    };

    window.verDatosActuales = async function() {
      try {
        // Intentar leer desde ambas ubicaciones
        console.log('Buscando datos en proyectos_correspondencia...');
        const ref = doc(db, "proyectos_correspondencia", "mapping");
        let snap = await getDoc(ref);
        
        let data = {};
        let fuente = 'proyectos_correspondencia';
        
        if (snap.exists() && Object.keys(snap.data()).length > 0) {
          data = snap.data();
          console.log('Datos encontrados en proyectos_correspondencia');
        } else {
          // Buscar en la ubicaci√≥n alternativa
          console.log('Buscando datos en project_scores (alternativa)...');
          const altRef = doc(db, "project_scores", "proyectos_mapping");
          const altSnap = await getDoc(altRef);
          
          if (altSnap.exists() && altSnap.data().mapping) {
            data = altSnap.data().mapping;
            fuente = 'project_scores (alternativa)';
            console.log('Datos encontrados en project_scores alternativa');
          }
        }
        
        const container = document.getElementById('datosActualesContainer');
        const section = document.getElementById('datosActualesSection');
        
        const entries = Object.entries(data).sort(([a], [b]) => a.localeCompare(b));
        
        if (entries.length === 0) {
          container.innerHTML = '<p style="color: #666; font-style: italic;">No hay datos guardados a√∫n.</p>';
        } else {
          container.innerHTML = `
            <p><strong>Total de proyectos:</strong> ${entries.length}</p>
            <p><small>Fuente: ${fuente}</small></p>
            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Nombre Checklist</th>
                  <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Nombre SAI</th>
                </tr>
              </thead>
              <tbody>
                ${entries.map(([checklist, sai]) => `
                  <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">${checklist}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${sai}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
        
        section.style.display = 'block';
        mostrarMensaje('Datos cargados correctamente', 'success');
        
      } catch (error) {
        console.error('Error al cargar datos:', error);
        mostrarMensaje('Error al cargar datos: ' + error.message, 'error');
      }
    };

    window.probarPermisos = async function() {
      mostrarMensaje('üîß Probando permisos de Firebase...', 'success');
      
      try {
        console.log('=== DIAGN√ìSTICO DE PERMISOS ===');
        console.log('Usuario actual:', currentUser);
        console.log('Email:', currentUser?.email);
        console.log('UID:', currentUser?.uid);
        
        // Probar lectura primero
        console.log('1. Probando LECTURA...');
        const ref = doc(db, "proyectos_correspondencia", "mapping");
        const snap = await getDoc(ref);
        console.log('‚úÖ Lectura exitosa:', snap.exists());
        
        // Probar escritura simple
        console.log('2. Probando ESCRITURA simple...');
        const testRef = doc(db, "test_permisos", "prueba");
        await setDoc(testRef, { 
          timestamp: new Date().toISOString(),
          user: currentUser.email,
          test: true 
        });
        console.log('‚úÖ Escritura en test_permisos exitosa');
        
        // Probar escritura en la colecci√≥n espec√≠fica
        console.log('3. Probando ESCRITURA en proyectos_correspondencia...');
        await setDoc(ref, { 
          "TEST_PROYECTO": "TEST_SAI",
          timestamp: new Date().toISOString(),
          user: currentUser.email
        }, { merge: true });
        console.log('‚úÖ Escritura en proyectos_correspondencia exitosa');
        
        mostrarMensaje('‚úÖ Todos los permisos funcionan correctamente. El problema puede ser transitorio.', 'success');
        
      } catch (error) {
        console.error('‚ùå Error en prueba de permisos:', error);
        console.error('C√≥digo de error:', error.code);
        console.error('Mensaje:', error.message);
        
        let mensaje = '‚ùå Error de permisos detectado: ';
        
        if (error.code === 'permission-denied') {
          mensaje += 'Las reglas de Firestore est√°n bloqueando la escritura. ';
          mensaje += 'Verifica las reglas en la consola de Firebase.';
        } else if (error.code === 'unauthenticated') {
          mensaje += 'Usuario no autenticado correctamente.';
        } else {
          mensaje += error.message;
        }
        
        mostrarMensaje(mensaje, 'error');
      }
    };

    window.limpiarTodosLosDatos = async function() {
      if (!currentUser) {
        mostrarMensaje('Usuario no autenticado', 'error');
        return;
      }
      
      // Verificar permisos del usuario
      const email = currentUser.email.toLowerCase();
      const adminEmails = [
        "csalcala@accessone.com.mx",
        "valonzo@accessone.com.mx", 
        "jfernandez@accessone.com.mx"
      ];
      
      if (!adminEmails.includes(email)) {
        mostrarMensaje('No tienes permisos para eliminar datos. Contacta a un administrador.', 'error');
        return;
      }
      
      if (!confirm('¬øEst√°s seguro de que deseas eliminar TODOS los datos de correspondencia de proyectos? Esta acci√≥n no se puede deshacer.')) {
        return;
      }
      
      try {
        const ref = doc(db, "proyectos_correspondencia", "mapping");
        await setDoc(ref, {});
        mostrarMensaje('Todos los datos han sido eliminados', 'success');
      } catch (error) {
        console.error('Error al limpiar datos:', error);
        mostrarMensaje('Error al limpiar datos: ' + error.message, 'error');
      }
    };

    // Funciones auxiliares
    async function guardarProyecto(checklistName, saiName) {
      if (!currentUser) {
        throw new Error('Usuario no autenticado');
      }
      
      // Verificar permisos del usuario
      const email = currentUser.email.toLowerCase();
      const adminEmails = [
        "csalcala@accessone.com.mx",
        "valonzo@accessone.com.mx", 
        "jfernandez@accessone.com.mx"
      ];
      
      if (!adminEmails.includes(email)) {
        throw new Error('No tienes permisos para modificar los datos de proyectos. Contacta a un administrador.');
      }
      
      try {
        // Primero intentar con la colecci√≥n original
        console.log('Intentando guardar en proyectos_correspondencia...');
        const ref = doc(db, "proyectos_correspondencia", "mapping");
        const updateData = {};
        updateData[checklistName] = saiName;
        
        await setDoc(ref, updateData, { merge: true });
        console.log(`Proyecto guardado en proyectos_correspondencia: ${checklistName} -> ${saiName}`);
        
      } catch (error) {
        console.error('Error con proyectos_correspondencia, intentando alternativa...', error);
        
        // Alternativa: usar project_scores que sabemos que funciona
        try {
          console.log('Intentando guardar en project_scores como alternativa...');
          const altRef = doc(db, "project_scores", "proyectos_mapping");
          const altSnap = await getDoc(altRef);
          
          let mapping = {};
          if (altSnap.exists() && altSnap.data().mapping) {
            mapping = altSnap.data().mapping;
          }
          
          mapping[checklistName] = saiName;
          
          await setDoc(altRef, { 
            mapping: mapping,
            lastUpdated: Timestamp.now(),
            updatedBy: currentUser.email
          }, { merge: true });
          
          console.log(`Proyecto guardado en project_scores alternativo: ${checklistName} -> ${saiName}`);
          
        } catch (altError) {
          console.error('Error tambi√©n en la alternativa:', altError);
          throw new Error(`Error de permisos en Firebase: ${error.message}`);
        }
      }
    }

    function mostrarVistaPrevia() {
      const previewContainer = document.getElementById('previewContainer');
      const previewSection = document.getElementById('previewSection');
      
      previewContainer.innerHTML = '';
      
      proyectosParaCargar.forEach((proyecto, index) => {
        const div = document.createElement('div');
        div.className = 'tienda-preview';
        div.innerHTML = `
          <div class="tienda-info">
            <strong>${proyecto.checklist}</strong> ‚Üí <em>${proyecto.sai}</em>
          </div>
          <button class="btn btn-danger" onclick="eliminarProyectoPreview(${index})" style="padding: 5px 10px; font-size: 12px;">
            Eliminar
          </button>
        `;
        previewContainer.appendChild(div);
      });
      
      previewSection.style.display = 'block';
    }

    window.eliminarProyectoPreview = function(index) {
      proyectosParaCargar.splice(index, 1);
      if (proyectosParaCargar.length === 0) {
        document.getElementById('previewSection').style.display = 'none';
      } else {
        mostrarVistaPrevia();
      }
    };

    function mostrarMensaje(mensaje, tipo) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.innerHTML = `<div class="status-message status-${tipo}">${mensaje}</div>`;
      
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 5000);
    }

    function mostrarProgreso(mostrar) {
      const progressContainer = document.getElementById('progressContainer');
      progressContainer.style.display = mostrar ? 'block' : 'none';
      if (!mostrar) {
        actualizarProgreso(0);
      }
    }

    function actualizarProgreso(porcentaje) {
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = porcentaje + '%';
      progressBar.textContent = Math.round(porcentaje) + '%';
    }

    // Sonido
    const keySound = document.getElementById("keySound");
    
    function playKeySound() {
      if (keySound) {
        keySound.currentTime = 0;
        keySound.play().catch(e => console.log('Audio play failed:', e));
      }
    }
    
    window.playKeySound = playKeySound;

    // Event listeners
    document.addEventListener("DOMContentLoaded", () => {
      // Sonido al escribir
      document.querySelectorAll('input, textarea').forEach(el => {
        el.addEventListener("keydown", e => {
          if (e.key.length === 1 || e.key === "Backspace" || e.key === "Delete") {
            playKeySound();
          }
        });
      });
      
      // Sonido en botones
      document.querySelectorAll('button').forEach(btn => {
        btn.addEventListener("click", playKeySound);
      });
      
      // Logout
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
          await signOut(auth);
          window.location.href = "login.html";
        } catch (err) {
          console.error("Error cerrando sesi√≥n:", err);
          alert("No se pudo cerrar sesi√≥n. Intenta de nuevo.");
        }
      });
      
      // Logo click
      const logo = document.getElementById("logo-accessone");
      if (logo) {
        logo.onclick = (e) => {
          e.preventDefault();
          const email = (currentUser?.email || "").toLowerCase();
          if (
            email === "csalcala@accessone.com.mx" ||
            email === "valonzo@accessone.com.mx" ||
            email === "jfernandez@accessone.com.mx"
          ) {
            window.location.href = "login-admin.html";
          } else {
            window.location.href = "index.html";
          }
        };
      }
    });
  </script>
</body>
</html>

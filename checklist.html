<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Check List de Estacionamientos</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Animaciones y mejoras visuales específicas para checklist */
    .card {
      background: var(--bg-white);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(46,0,96,0.12);
      padding: 48px 36px 36px 36px;
      margin-top: -32px;
      border: none;
      animation: fadeInCard 0.7s cubic-bezier(.4,0,.2,1);
      transition: box-shadow 0.25s, transform 0.18s;
    }
    @keyframes fadeInCard {
      from { opacity: 0; transform: translateY(40px);}
      to { opacity: 1; transform: none;}
    }
    .card:hover {
      box-shadow: 0 12px 40px #FFD40033, 0 2px 0 #00B2A9;
      transform: translateY(-2px) scale(1.01);
    }
    .form-header label, .staff-section h3, .metrics-section h3 {
      transition: color 0.2s;
    }
    .form-header label:focus-within,
    .staff-section h3:focus,
    .metrics-section h3:focus {
      color: var(--accent);
    }
    .form-header input[type="text"]:focus,
    .form-header input[type="date"]:focus {
      border: 2px solid var(--accent);
      background: #fffbe7;
      transition: border 0.2s, background 0.2s;
    }
    .form-header button, #logoutBtn, #searchBtn, #btn-guardar-calif {
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      box-shadow: 0 2px 8px #FFD40022;
    }
    .form-header button:hover, #logoutBtn:hover, #searchBtn:hover, #btn-guardar-calif:hover {
      background: linear-gradient(90deg, #FFD400 60%, #00B2A9 100%);
      color: #fff;
      transform: scale(1.04);
      box-shadow: 0 4px 16px #FFD40033;
    }
    .sticky-score {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      animation: popIn 0.7s;
      box-shadow: 0 2px 12px #FFD40022;
      border-bottom: 2px solid var(--secondary);
      border-radius: 18px 18px 0 0;
      background: #fffbe7;
      margin-bottom: 18px;
      position: sticky;
      top: 0;
      z-index: 1; /* menor que el header para no taparlo */
      transition: box-shadow 0.2s;
      min-height: 210px;
    }
    #totalCalif {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 22px;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      min-height: 90px;
    }
    #totalCalif > span:first-child {
      font-size: 1.1em;
      font-weight: 700;
      color: var(--primary);
      min-width: 90px;
    }
    #totalValue {
      font-size: 2em;
      font-weight: 900;
      color: var(--primary);
      min-width: 70px;
      text-align: right;
      margin-right: 8px;
    }
    #progressContainer {
      height: 18px;
      width: 140px;
      min-width: 140px;
      margin-bottom: 0;
    }
    #progressBar {
      border-radius: 12px;
      background: linear-gradient(90deg, #FFD400 60%, #00B2A9 100%);
      height: 100%;
      width: 0;
      transition: width 0.5s cubic-bezier(.4,0,.2,1);
    }
    #gaugeContainer {
      width: 90px;
      height: 45px;
      margin: 0 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #mascotaContainer {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 16px;
    }
    #mascotaContainer img {
      height: 54px;
      width: 54px;
      border-radius: 50%;
      border: 2px solid #FFD400;
      margin-left: 0;
      box-shadow: 0 2px 8px #FFD40033;
      background: #fff;
    }
    /* Opciones tipo botón */
    .ok-options {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 18px;
      height: 100%;
      min-height: 64px;
    }
    .ok-options label {
      flex: 1 1 0;
      min-width: 0;
      margin: 0;
      padding: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ok-options input[type="radio"] {
      display: none;
    }
    .ok-options span {
      font-size: 1.1em;
      padding: 12px 0;
      border-radius: 14px;
      border: 2px solid var(--primary);
      background: #f9f9fb;
      color: var(--primary);
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(46,0,96,0.08);
      transition: background 0.2s, color 0.2s, border 0.2s, box-shadow 0.2s, transform 0.18s;
      position: relative;
      width: 100%;
      display: block;
      text-align: center;
      min-width: 90px;
      margin: 0 2px;
    }
    .ok-options input[type="radio"]:checked + span {
      background: linear-gradient(90deg, #2E0060 60%, #00B2A9 100%);
      color: #FFD400;
      border-color: #FFD400;
      box-shadow: 0 4px 16px #00B2A911;
      transform: scale(1.08);
    }
    /* Comentarios y textarea alineados */
    .comment-col {
      width: 40%;
      vertical-align: top;
      overflow: hidden;
      padding: 0 12px;
      box-sizing: border-box;
    }
    .comment-col textarea, .comment-col input[type="number"] {
      border-radius: 10px;
      border: 2px solid #e0e3e8;
      box-shadow: 0 1px 4px #FFD40011;
      padding: 16px;
      font-size: 1.1em;
      transition: border 0.2s, box-shadow 0.2s;
      min-height: 60px;
      max-width: 100%;
      width: 100%;
      resize: vertical;
      background: #f9f9fb;
      margin-top: 4px;
      margin-bottom: 0;
      display: block;
    }
    .comment-col textarea:focus, .comment-col input[type="number"]:focus {
      border: 2px solid var(--accent);
      background: #fffbe7;
    }
    .char-count {
      font-size: .8em;
      color: var(--primary);
      text-align: right;
      margin-top: 4px;
      letter-spacing: 0.5px;
      transition: color 0.2s;
    }
    /* Table layout fix */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 0;
      table-layout: fixed;
      background: #fff;
      border-radius: 0 0 18px 18px;
      box-shadow: 0 1px 4px #FFD40011;
      overflow: hidden;
      animation: fadeInCard 0.7s;
    }
    th, td {
      border: 1px solid var(--gray);
      padding: 12px 10px;
      vertical-align: top;
      font-size: 1em;
      transition: background 0.2s;
      text-align: left;
    }
    th {
      background: var(--primary);
      color: #fff;
      font-size: 1.1em;
      border: none;
      text-align: center;
      font-weight: 700;
    }
    tbody tr {
      transition: background 0.2s;
      height: 120px;
    }
    tbody tr:hover td {
      background: #fffbe7;
    }
    /* Header y formularios */
    header {
      display: flex;
      align-items: center;
      gap: 18px;
      background: linear-gradient(90deg, #2E0060 60%, #00B2A9 100%);
      border-radius: 24px 24px 0 0;
      padding: 18px 32px;
      margin-bottom: 18px; /* separa header del contenido */
      position: relative;
      z-index: 2; /* asegura que el header esté arriba */
    }
    header img {
      height: 48px;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 2px 8px #FFD40033;
    }
    header h1 {
      color: #FFD400;
      font-size: 2em;
      font-weight: 900;
      margin: 0;
      letter-spacing: 1.5px;
      text-shadow: 0 2px 8px #2E006022;
    }
    .form-header {
      display: grid;
      grid-template-columns: 1.2fr 0.7fr 1fr 1fr 1fr;
      gap: 18px;
      align-items: end;
      margin-bottom: 18px;
      background: none;
      padding: 0;
    }
    .form-header label, .form-header button {
      margin: 0;
    }
    @media (max-width: 900px) {
      .form-header {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }
    /* Sticky score */
    .sticky-score {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      animation: popIn 0.7s;
      box-shadow: 0 2px 12px #FFD40022;
      border-bottom: 2px solid var(--secondary);
      border-radius: 18px 18px 0 0;
      background: #fffbe7;
      margin-bottom: 18px;
      position: sticky;
      top: 0;
      z-index: 1; /* menor que el header para no taparlo */
      transition: box-shadow 0.2s;
      min-height: 110px;
      padding: 0 0 0 0;
    }
    #totalCalif {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 22px;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      min-height: 90px;
    }
    #totalCalif > span:first-child {
      font-size: 1.1em;
      font-weight: 700;
      color: var(--primary);
      min-width: 90px;
    }
    #totalValue {
      font-size: 2em;
      font-weight: 900;
      color: var(--primary);
      min-width: 70px;
      text-align: right;
      margin-right: 8px;
    }
    #progressContainer {
      height: 18px;
      width: 140px;
      min-width: 140px;
      margin-bottom: 0;
    }
    #gaugeContainer {
      width: 90px;
      height: 45px;
      margin: 0 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #mascotaContainer {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 16px;
    }
    #mascotaContainer img {
      height: 54px;
      width: 54px;
      border-radius: 50%;
      border: 2px solid #FFD400;
      margin-left: 0;
      box-shadow: 0 2px 8px #FFD40033;
      background: #fff;
    }
    /* Staff y métricas en tarjetas horizontales */
    .staff-metrics-row {
      display: flex;
      gap: 24px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .staff-section, .metrics-section {
      background: #f9f9fb;
      border-radius: 14px;
      box-shadow: 0 1px 4px #FFD40011;
      padding: 18px 18px 10px 18px;
      flex: 1 1 320px;
      min-width: 260px;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .staff-section h3, .metrics-section h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 1.1em;
      color: var(--primary);
      font-weight: 800;
      letter-spacing: 0.5px;
    }
    .staff-grid, .metrics-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 18px;
      align-items: center;
    }
    .staff-item, .metric-item {
      display: flex;
      flex-direction: column;
      min-width: 110px;
      flex: 1 1 110px;
      gap: 2px;
    }
    .staff-item label, .metric-item label {
      font-size: 0.98em;
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 2px;
    }
    .staff-item input[type="number"] {
      border-radius: 7px;
      border: 1.5px solid #e0e3e8;
      padding: 6px 8px;
      font-size: 1em;
      background: #fff;
      width: 100%;
      min-width: 60px;
      max-width: 90px;
    }
    .staff-item span, .metric-item span {
      font-size: 1em;
      font-weight: 700;
      color: #2E0060;
      margin-top: 2px;
    }
    /* Responsive */
    @media (max-width: 900px) {
      .form-header { flex-direction: column; gap: 8px; }
      .staff-metrics-row { flex-direction: column; gap: 10px; }
      .staff-section, .metrics-section { min-width: 0; width: 100%; }
      #totalCalif { flex-direction: column; gap: 8px; min-height: 0; }
      .sticky-score { min-height: 80px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a id="logo-link" href="index.html" style="display:flex;align-items:center;text-decoration:none;">
        <img src="logo.jpg" alt="AccessOne Logo" id="logo-accessone">
      </a>
      <h1>Check List de Estacionamientos</h1>
    </header>
    <div class="card">
      <div class="form-header">
        <label>
          Proyecto:
          <input type="text" id="project" list="projectList" placeholder="Escribe para filtrar..." autocomplete="off" required readonly onfocus="this.removeAttribute('readonly');" onblur="this.setAttribute('readonly','readonly');">
        </label>
  <button id="searchBtn" type="button">Buscar</button>
  <button id="markPositiveBtn" type="button">Marcar Positivas</button>
        <label>
          Fecha:
          <input type="date" id="date" readonly disabled>
        </label>
        <label>
          Gerente:
          <input type="text" id="manager" readonly>
        </label>
        <datalist id="projectList"></datalist>
        <button id="logoutBtn" type="button">Cerrar Sesión</button>
      </div>

      <!-- Staff y métricas en fila -->
      <div class="staff-metrics-row">
        <div class="staff-section">
          <h3>Control de Personal</h3>
          <div class="staff-grid">
            <div class="staff-item">
              <label for="plantillaInicial">Plantilla Inicial:</label>
              <input type="number" id="plantillaInicial" min="0" required>
            </div>
            <div class="staff-item">
              <label for="altas">Altas:</label>
              <input type="number" id="altas" min="0" required>
            </div>
            <div class="staff-item">
              <label for="bajas">Bajas:</label>
              <input type="number" id="bajas" min="0" required>
            </div>
            <div class="staff-item">
              <label>Tasa de Rotación:</label>
              <span id="rotacionValue">0%</span>
            </div>
          </div>
        </div>
        <div class="metrics-section">
          <h3>Métricas de Desempeño</h3>
          <div class="metrics-grid">
            <div class="metric-item">
              <label>Tasa de Cumplimiento:</label>
              <span id="tasaCumplimiento">0%</span>
            </div>
            <div class="metric-item">
              <label>Incidencias Críticas:</label>
              <span id="incidenciasCriticas">0</span>
            </div>
            <div class="metric-item">
              <label>Lámparas Fundidas:</label>
              <span id="lamparasFundidas">0%</span>
            </div>
            <div class="metric-item">
              <label>Total Quejas:</label>
              <span id="totalQuejas">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Calificación + gauge + mascota -->
      <div class="sticky-score">
        <div id="totalCalif">
          <span>Calificación:</span>
          <span id="totalValue">0%</span>
          <div id="progressContainer">
            <div id="progressBar"></div>
          </div>
          <div id="gaugeContainer">
            <canvas id="gauge" width="140" height="70"></canvas>
          </div>
          <div id="mascotaContainer">
            <img id="mascotaImg" src="mascota_rojo.png" alt="Mascota">
          </div>
        </div>
      </div>

      <!-- Checklist dinámico -->
      <div id="sections"></div>

      <!-- Historial de calificaciones -->
      <div id="lastScores"></div>

      <!-- Firmas -->
      <div class="signatures">
        <div class="signature-line">Responsable de CheckList</div>
        <div class="signature-line">Gerente del Proyecto</div>
      </div>
    </div>
    <!-- Agrega el audio para el sonido de tecla/click -->
<audio id="keySound" src="key.mp3" preload="auto"></audio>
  </div>
  <script type="module">
  // 1) Firebase core (auth y base de datos)
  import { auth, db } from "./js/firebase-config.js";

  // 2) Auth: onAuthStateChanged + signOut en una sola línea
  import { onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  // 3) Firestore (documentos y timestamps)
  import { doc, getDoc, setDoc, updateDoc, arrayUnion, Timestamp }
    from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";


    // Lista completa de proyectos
    const ALL_PROJECTS = [
      "Adagio","Boulevard 5 de mayo","Buenavista","Centenario","Combo Aeropuerto",
      "Combo Azcapotzalco","Combo Carrizal","Combo Cuautitlán","Combo Satélite",
      "Comitán","Cuautitlán 1ero de mayo","Dorada I Dorada II","Galerías VHS",
      "Hermosillo","Insurgentes Nte.","Kómplex","La Raza","León","Tijuana",
      "Macroplaza Insurgentes Tijuana","Moroleon","Paroli","Patio Pedregal",
      "Portal Churubusco","San Manuel","Símbolos Patrios","Suburbia","Tacámbaro",
      "Tapachula","Tepeyac","Tlalpan","Tlaxcala","Uruapan","Vía San Ángel",
      "Zitácuaro","Playa del Carmen","Paseo Akia","WE Periferico","Pirules",
      "La Mangana","WE Horacio","Tacubaya","Mariano Escobedo","Ferrocarril Hidalgo",
      "Sam´s Oaxaca","Plaza Alamos","San Pedrito"
    ];
    // Mapeo proyecto -> gerente (se cargará dinámicamente)
    let projectManagerMap = {};
    
    // Correspondencia proyecto checklist -> proyecto SAI (se cargará dinámicamente)
    let projectSaiMap = {};

    // Patrones de preguntas negativas (responder "Sí" penaliza)
    const negativeLabels = [
      /robo total/i,
      /robo parcial/i,
      /quejas recibidas/i,
      /presenta baches/i,
      /lámparas fundidas/i,
      /diferencias.*boletaje/i,
      /diferencias.*dep[oó]sito/i,
      /faltan plantas/i,
      /tiene alguna falla/i
    ];

    // Lista completa de ítems del checklist (con los cambios que pediste)
    const items = [
      "Cuenta con (Licencia, Permiso Funcionamiento)",
      "Cuenta con Póliza de Seguro Vigente? (Vehículos, Motocicletas)",
      "Cuenta con hologramas de PROFECO vigentes en cada equipo? (Emisoras, Receptora, Cajeros de pago, TPV/Reloj Checador)",
      "¿Ha tenido algún robo total? (auto, camioneta, motocicleta)",
      "¿Ha tenido algún robo parcial? (auto, camioneta, motocicleta)",
      "-- OPERACIÓN: Personal de Operación --",
      "El Supervisor de zona realiza el checklist una vez al mes?",
      "El estacionamiento cuenta con encargado(s) o responsable? (Por turno, Por estaciónamiento)",
      "La plantilla de cajeros y/o auxiliares completa? (Matutino, Vespertino, Nocturno)",
      "Número de quejas recibidas en estos 30 días?",
      "Desglosar quejas",
      "El personal cuenta con las siguientes características (Uniforme Completo y en buen estado, Gafete de Identificación)",
      "El personal conoce y aplica el plan de contingencia?",
      "Cuenta con directorio de servicio de emergencia actualizado?",
      "-- Operación: Equipos --",
      "Todas las entradas y salidas abiertas? (Automático, Push Botón, Por Sensor)",
      "Emisor de boletos por cada entrada y funcionando?",
      "Funcionan todos los cajeros de pago?",
      "Validadora (receptora) y TPV en cada salida y funcionando?",
      "Se cuenta con interfonía en el estacionamiento?",
      "Cuenta con CCTV y funciona correctamente?",
      "Se realiza mantenimiento de UPS / ¿tiene alguna falla?",
      "Visita de técnico",
      "Las casetas se encuentran en servicio dentro del horario de la tienda?",
      "Las casetas se encuentran en buenas condiciones? (Vidrios, Pintura, Cerrajería, Rótulos/Señalización, Iluminación, Mobiliario, Limpieza/Sanitización)",
      "Imagen de los equipos (Hojalatería, Pintura, Limpieza, Anclaje correcto, Cerrados en general)",
      "Cuentan con radios de comunicación y funcionando?",
      "Cuenta con relojes checadores y funcionando?",
      "-- Operación: Oficina Administrativa --",
      "Oficina Administrativa en buenas condiciones? (Vidrios, Pintura, Cerrajería, Rótulos/Señalización, Iluminación, Mobiliario)",
      "Cuenta con bitácora de novedades del concesionario?",
      "Bitácora actualizada",
      "Cuenta con catálogo de firmas actualizado de gerencias?",
      "Cuenta con Kit de auxilio vial? (Gato hidráulico, Llave de cruz, Arrancador/batería, Herramienta básica) y el arrancador funciona?",
      "Los tótems y señalamientos cuentan con la información completa, actualizada y en buenas condiciones?",
      "Requisiciones / Pendientes",
      "-- MANTENIMIENTO: Equipos --",
      "Preventivo al mes",
      "Equipos con buena imagen ?",
      "-- Mantenimiento: Bacheo Menor --",
      "El estacionamiento presenta baches?",
      "-- Mantenimiento: Pintura --",
      "Se ejecuta el plan de pintura de acuerdo al calendario?",
      "Pintura (si no, ¿por qué?)",
      "Guarniciones",
      "La pintura en cajones se encuentra en buenas condiciones? (Normal, discapacitados, Rosas)",
      "La pintura en flechas de circulación se encuentran en buenas condiciones?",
      "La pintura en puntos de reunión, guarniciones y topes se encuentran en buenas condiciones?",
      "-- Mantenimiento: Jardinería --",
      "Se realiza poda de pasto y setos?",
      "Faltan plantas y árboles en jardineras?",
      "Los troncos de los árboles están encalados?",
      "Se realiza el riego periódicamente?",
      "-- Mantenimiento: Iluminación --",
      "Existen lámparas fundidas?",
      "Lámparas porcentaje",
      "-- VIGILANCIA: Personal de Seguridad --",
      "Se encuentra completa la plantilla de Vigilancia de acuerdo a la necesidad de la operación?",
      "Están uniformados los vigilantes del estacionamiento?",
      "Se diferencia el personal de vigilancia del personal operativo?",
      "El personal cuenta con gafete de identificación a la vista?",
      "El personal de vigilancia realiza los rondines en el estacionamiento?",
      "Cuentan con radios de intercomunicación?",
      "Cuentan con bitácora de novedades y se encuentra al día?",
      "-- LIMPIEZA: Personal de Limpieza --",
      "Cuenta con personal de limpieza suficiente para la operación? (Matutino, Vespertino, Total por día)",
      "El personal de limpieza cuenta con uniforme completo y gafete a la vista?",
      "Estacionamiento limpio en general?",
      "Se realiza desengrasado de cajones de estacionamiento?",
      "Cuenta con el material para realizar la limpieza y sanitización en oficina, equipos de estacionamiento?",
      "Cuenta con líquido desengrasante para la limpieza de cajones?",
      "-- PROTECCIÓN CIVIL --",
      "El estacionamiento cuenta con extintores?",
      "Los extintores están vigentes? (Fecha de vigencia: Concesionario/PV, Extintores Tienda)",
      "Gabinetes de Extintores en buenas condiciones? (Casco/Botas/Guantes, Chamarra/Pantalón, Palas/Rótulos/Megáfono)",
      "El estacionamiento cuenta con botes areneros en buenas condiciones? (Bolsas, Palas, Nº de botes areneros)",
      "Cuenta con señalización de ubicación de equipo de protección civil y rutas de evacuación en buen estado?",
      "Cuentan con botiquín de primeros auxilios con el material necesario y completo?",
      "-- ÁREA ADMINISTRATIVA --",
      "Los boletos se encuentran ordenados por día?",
      "Existen diferencias del boletaje físico vs reporte?",
      "¿Existe control de ingreso diario?",
      "Existen diferencias entre el depósito realizado vs reportes de ingresos?",
      "Se lleva un control del total de pensiones? (Número de pensiones, Costo de pensión)",
      "Se lleva un control de tarjetas de proximidad y/o cortesías? (Promedio diario de Cortesías)",
      "¿Los tickets están bien llenados?",
      "-- PENSIONES --",
      "Cuentas con pensiones?",
      "Contratos completos?",
      "Se utilizan los candados adecuadamente?",
      "Tienes inventario?"
    ];
    // --- Variables globales ---
    let currentUser = null;
    let userProjects = [];
    let selectedProject = "";

    // Inicializa la app una vez autenticado
    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      
      // Obtener proyectos dinámicamente desde la base de datos
      console.log('🚀 Iniciando carga de proyectos...');
      await loadProjectsFromDatabase();
      console.log('📋 Proyectos cargados, total:', userProjects.length);
      
      // Verificar permisos del usuario
      const snap = await getDoc(doc(db, "users", user.uid));
      if (!snap.exists()) {
        alert("No tienes permisos configurados. Contacta al administrador.");
        window.location.href = "login.html";
        return;
      }
      
      // Guardar si es admin para el logo
      window._isAdmin = !!(snap.data().isAdmin || snap.data().admin);
      
      if (!Array.isArray(userProjects) || userProjects.length === 0) {
        alert("No se pudieron cargar los proyectos. Verifica la configuración.");
        console.error('❌ userProjects está vacío o no es array:', userProjects);
        window.location.href = "login.html";
        return;
      }
      
      console.log('✅ Construyendo lista de proyectos...');
      buildProjectList();
      
      if (userProjects.length === 1) {
        document.getElementById('project').value = userProjects[0];
        assignManager();
      }
      
      console.log('🎉 Inicialización completada exitosamente');
    });

    // Genera el datalist SOLO con los proyectos permitidos del usuario
function buildProjectList() {
  const datalist = document.getElementById('projectList');
  datalist.innerHTML = "";
  userProjects.forEach(p => {
    const option = document.createElement("option");
    option.value = p;
    datalist.appendChild(option);
  });
}

// Cargar proyectos dinámicamente desde la base de datos
async function loadProjectsFromDatabase() {
  try {
    console.log('Cargando proyectos desde la base de datos...');
    
    let proyectos = {};
    let fuente = '';
    
    // Intentar desde proyectos_correspondencia primero (misma lógica que ingreso-tiendas)
    try {
      console.log('Intentando leer desde proyectos_correspondencia...');
      const ref = doc(db, "proyectos_correspondencia", "mapping");
      const snap = await getDoc(ref);
      
      if (snap.exists()) {
        const data = snap.data();
        // Filtrar campos de metadata como timestamp, user, etc.
        Object.keys(data).forEach(key => {
          if (key !== 'timestamp' && key !== 'user' && key !== 'lastUpdated' && key !== 'updatedBy') {
            proyectos[key] = data[key];
          }
        });
        
        if (Object.keys(proyectos).length > 0) {
          fuente = 'proyectos_correspondencia';
          console.log('✅ Proyectos cargados desde proyectos_correspondencia:', Object.keys(proyectos).length);
        }
      }
    } catch (error) {
      console.log('❌ Error al leer proyectos_correspondencia:', error.message);
    }
    
    // Si no encontró datos, buscar en la ubicación alternativa
    if (Object.keys(proyectos).length === 0) {
      try {
        console.log('Intentando leer desde project_scores (alternativa)...');
        const altRef = doc(db, "project_scores", "proyectos_mapping");
        const altSnap = await getDoc(altRef);
        
        if (altSnap.exists() && altSnap.data().mapping) {
          proyectos = altSnap.data().mapping;
          fuente = 'project_scores/proyectos_mapping';
          console.log('✅ Proyectos cargados desde project_scores (alternativa):', Object.keys(proyectos).length);
        }
      } catch (altError) {
        console.log('❌ Error al leer project_scores alternativa:', altError.message);
      }
    }
    
    console.log(`📊 Datos encontrados en ${fuente}:`, proyectos);
    
    // Convertir los nombres de checklist a array para userProjects
    userProjects = Object.keys(proyectos).sort();
    
    // Guardar la correspondencia checklist -> SAI
    projectSaiMap = proyectos;
    
    // Cargar gerentes desde la base de datos (si existe)
    await loadProjectManagers();
    
    if (userProjects.length === 0) {
      console.warn('⚠️ No se encontraron proyectos en la base de datos');
      // Fallback: proyectos por defecto para que no se rompa el sistema
      userProjects = [
        "Combo Azcapotzalco",
        "Adagio", 
        "Boulevard 5 de mayo",
        "Buenavista"
      ];
      console.log('🔄 Usando proyectos por defecto:', userProjects.length);
    }
    
    console.log('🎯 Proyectos finales cargados:', userProjects);
    console.log('🗺️ Mapeo checklist -> SAI:', projectSaiMap);
    
  } catch (error) {
    console.error('💥 Error crítico al cargar proyectos:', error);
    // Fallback en caso de error
    userProjects = [
      "Combo Azcapotzalco",
      "Adagio", 
      "Boulevard 5 de mayo",
      "Buenavista"
    ];
    projectSaiMap = {};
  }
}

// Cargar gerentes de proyectos desde la base de datos
async function loadProjectManagers() {
  try {
    console.log('Cargando gerentes de proyectos...');
    
    const ref = doc(db, "project_managers", "mapping");
    const snap = await getDoc(ref);
    
    if (snap.exists()) {
      projectManagerMap = snap.data();
      console.log('Gerentes cargados:', Object.keys(projectManagerMap).length);
    } else {
      console.log('No se encontró configuración de gerentes, usando valores por defecto');
      // Mantener algunos valores por defecto para que funcione
      projectManagerMap = {
        "Combo Azcapotzalco": "ISMAEL VENTURA",
        "Adagio": "CARLOS BRUNO VALENCIA RAMÍREZ",
        "Boulevard 5 de mayo": "CÁNDIDO FCO. RUBÉN BECERRIL MARAVILLAS",
        "Buenavista": "DORIAN GUADALUPE NIETO VÁZQUEZ"
      };
    }
    
  } catch (error) {
    console.error('Error al cargar gerentes:', error);
    projectManagerMap = {};
  }
}
    


    // --- UI dinámico, igual que siempre pero sin cortes ni elipsis ---
    function createSections() {
      const container = document.getElementById('sections');
       container.innerHTML = "";    // ← limpia todo antes de volver a renderizar
      let sections = [], current = { title: 'General', items: [] };

      items.forEach((label, idx) => {
        if (label.startsWith('--')) {
          if (current.items.length) sections.push(current);
          current = { title: label.replace(/^--\s*/, ''), items: [] };
        } else {
          current.items.push({ label, idx: idx + 1 });
        }
      });
      sections.push(current);

      sections.forEach(sec => {
        const d = document.createElement('details');
        d.open = true;
        d.className = 'section-details';

        const s = document.createElement('summary');
        s.textContent = sec.title;
        d.appendChild(s);

        const t = document.createElement('table');
        t.innerHTML = `
          <thead>
            <tr>
              <th class="item-col">Ítem</th>
              <th class="comment-col">Comentario / Datos</th>
              <th class="ok-col">Resultado</th>
            </tr>
          </thead>
          <tbody>
            ${sec.items.map(it => {
              // Desglosar quejas (ítem 11) ahora igual que "Requisiciones / Pendientes"
              if (it.label === 'Desglosar quejas') {
                return `
                  <tr>
                    <td class="item-col">${it.idx}. ${it.label}</td>
                    <td class="comment-col">
                      <div>
                        <label><input type="checkbox" name="dept${it.idx}" value="Obras"> Obras</label>
                        <label><input type="checkbox" name="dept${it.idx}" value="Soporte"> Soporte</label>
                        <label><input type="checkbox" name="dept${it.idx}" value="RH"> RH</label>
                        <label><input type="checkbox" name="dept${it.idx}" value="Compras"> Compras</label>
                      </div>
                      <textarea name="tickets${it.idx}" maxlength="200" placeholder="Números de ticket..."></textarea>
                      <div class="char-count">0/200</div>
                    </td>
                    <td class="ok-col ok-options">
                      ${['Sí', 'No', 'No Aplica'].map(v => `
                        <label>
                          <input type="radio" name="ok${it.idx}" value="${v}" onchange="updateTotal()" />
                          <span>${v}</span>
                        </label>
                      `).join('')}
                    </td>
                  </tr>
                `;
              }
              // Lámparas porcentaje
              else if (it.label === 'Lámparas porcentaje') {
                return `
                  <tr class="lamp-row">
                    <td class="item-col">${it.idx}. ${it.label}</td>
                    <td class="comment-col">
                      <label class="lamp-label">Cuántas se tienen:</label>
                      <input type="number" min="0" id="lamps-total" placeholder="0">
                      <label class="lamp-label">Cuántas fundidas:</label>
                      <input type="number" min="0" id="lamps-fundidas" placeholder="0">
                    </td>
                    <td class="ok-col">
                      <span id="lamps-percentage" class="lamp-percentage">0%</span>
                    </td>
                  </tr>
                `;
              }
              // Requisiciones / Pendientes (ítem 36)
              else if (it.label === 'Requisiciones / Pendientes') {
                return `
                  <tr>
                    <td class="item-col">${it.idx}. ${it.label}</td>
                    <td class="comment-col">
                      <div>
                        <label><input type="checkbox" name="dept${it.idx}" value="Obras"> Obras</label>
                        <label><input type="checkbox" name="dept${it.idx}" value="Soporte"> Soporte</label>
                        <label><input type="checkbox" name="dept${it.idx}" value="RH"> RH</label>
                        <label><input type="checkbox" name="dept${it.idx}" value="Compras"> Compras</label>
                      </div>
                      <textarea name="tickets${it.idx}" maxlength="200" placeholder="Números de ticket..."></textarea>
                      <div class="char-count">0/200</div>
                    </td>
                    <td class="ok-col ok-options">
                      ${['Sí', 'No', 'No Aplica'].map(v => `
                        <label>
                          <input type="radio" name="ok${it.idx}" value="${v}" onchange="updateTotal()" />
                          <span>${v}</span>
                        </label>
                      `).join('')}
                    </td>
                  </tr>
                `;
              }
              // Casos por defecto
              else {
                return `
                  <tr>
                    <td class="item-col">${it.idx}. ${it.label}</td>
                    <td class="comment-col">
                      <textarea name="coment${it.idx}" maxlength="200"></textarea>
                      <div class="char-count">0/200</div>
                    </td>
                    <td class="ok-col ok-options">
                      ${['Sí', 'No', 'No Aplica'].map(v => `
                        <label>
                          <input type="radio" name="ok${it.idx}" value="${v}" onchange="updateTotal()" />
                          <span>${v}</span>
                        </label>
                      `).join('')}
                    </td>
                  </tr>
                `;
              }
            }).join('')}
          </tbody>
        `;
        d.appendChild(t);
        container.appendChild(d);
      });

      // Contador de caracteres
      document.querySelectorAll('textarea').forEach(ta => {
        ta.addEventListener('input', e => {
          e.target.nextElementSibling.textContent = `${e.target.value.length}/200`;
        });
      });

      // Eventos para lámparas
      const totalInput = document.getElementById('lamps-total');
      const fundidasInput = document.getElementById('lamps-fundidas');
      if (totalInput && fundidasInput) {
        totalInput.addEventListener('input', calculateLampPercentage);
        fundidasInput.addEventListener('input', calculateLampPercentage);
      }
    }


 
    // --- Cálculo y UI: porcentaje de lámparas fundidas
    function calculateLampPercentage() {
      const total = parseInt(document.getElementById('lamps-total').value, 10) || 0;
      const fundidas = parseInt(document.getElementById('lamps-fundidas').value, 10) || 0;
      let porcentaje = 0;
      if (total > 0) porcentaje = Math.round((fundidas / total) * 100);
      document.getElementById('lamps-percentage').textContent = porcentaje + '%';
    }

    // Actualiza calificación total y barra de progreso
    function updateTotal() {
      let sum = 0;
      // Obtener índices de preguntas evaluables (ignorar secciones y 'Lámparas porcentaje')
      const evaluableIndexes = [];
      items.forEach((l, i) => {
        if (!l.startsWith('--') && l !== 'Lámparas porcentaje') evaluableIndexes.push(i);
      });

      // Primeras 5 preguntas (si hay menos de 5, toman el 25% total igualmente)
      const firstCount = Math.min(5, evaluableIndexes.length);
      const restCount = Math.max(0, evaluableIndexes.length - firstCount);

      // Pesos totales: primer bloque = 25%, resto = 75%
      const weightFirst = firstCount > 0 ? 25 / firstCount : 0;
      const weightRest = restCount > 0 ? 75 / restCount : 0;

      evaluableIndexes.forEach((idx, order) => {
        const l = items[idx];
        const num = idx + 1;
        const sel = document.querySelector(`input[name="ok${num}"]:checked`);
        const val = sel ? sel.value : null;
        const isNegative = negativeLabels.some(rx => rx.test(l));

        const isInFirst = order < firstCount;
        const w = isInFirst ? weightFirst : weightRest;

        if (isNegative) {
          if (val === 'Sí') sum -= w;
          else if (val === 'No' || val === 'No Aplica') sum += w;
        } else {
          if (val === 'Sí' || val === 'No Aplica') sum += w;
        }
      });

      const total = Math.max(0, Math.min(100, sum));
      document.getElementById('totalValue').textContent = total.toFixed(2) + '%';
      document.getElementById('progressBar').style.width = `${total}%`;
      drawGauge(total);
      const mascotaImg = document.getElementById('mascotaImg');
if (mascotaImg) {
  if (total <= 40) {
    mascotaImg.src = "mascota_rojo.png";       // ENOJADO
  } else if (total <= 75) {
    mascotaImg.src = "mascota_amarillo.png";   // TRISTE
  } else {
    mascotaImg.src = "mascota_verde.png";      // CONTENTO
  }
}
    }
    window.updateTotal = updateTotal; 

    // Marcar todas las respuestas que dan positivo en la calificación
    function markAllPositive() {
      // Recorre cada ítem evaluable y marca la opción que representa positivo
      items.forEach((l, i) => {
        if (!l.startsWith('--') && l !== 'Lámparas porcentaje') {
          const num = i + 1;
          const isNegative = negativeLabels.some(rx => rx.test(l));
          // Para preguntas 'negativas' marcar 'No' para evitar penalización
          const desired = isNegative ? 'No' : 'Sí';
          const radio = document.querySelector(`input[name="ok${num}"][value="${desired}"]`);
          if (radio) radio.checked = true;
        }
      });

      // Ajustar campos de lámparas a 0 para reflejar estado positivo
      const totalInput = document.getElementById('lamps-total');
      const fundidasInput = document.getElementById('lamps-fundidas');
      if (totalInput) totalInput.value = '';
      if (fundidasInput) fundidasInput.value = '';

      updateTotal();
    }

    document.getElementById('markPositiveBtn').addEventListener('click', markAllPositive);

    // Dibuja el semicírculo y aguja en el gauge
    function drawGauge(value) {
      if (!window.ctx) return;
      const ctx = window.ctx;
      const centerX = 70; // la mitad de 140
      const centerY = 70; // la base del semicírculo
      const radius = 68;  // un poco menos que 70 para no salir del canvas

      // Limpiar TODO el canvas
      ctx.clearRect(0, 0, 140, 70);

      // Rojo (180°→120°)
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, radius, Math.PI, Math.PI + Math.PI/3, false);
      ctx.fillStyle = '#ff4d4d';
      ctx.fill();

      // Amarillo (120°→60°)
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, radius, Math.PI + Math.PI/3, Math.PI + 2*Math.PI/3, false);
      ctx.fillStyle = '#ffcc00';
      ctx.fill();

      // Verde (60°→0°)
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, radius, Math.PI + 2*Math.PI/3, 2*Math.PI, false);
      ctx.fillStyle = '#00cc44';
      ctx.fill();

      // Aguja (0% a la izquierda, 100% a la derecha)
      const angle = Math.PI + (value / 100) * Math.PI;
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(
        centerX + (radius - 10) * Math.cos(angle),
        centerY + (radius - 10) * Math.sin(angle)
      );
      ctx.lineWidth = 4;
      ctx.strokeStyle = '#000';
      ctx.stroke();

      // Círculo central
      ctx.beginPath();
      ctx.arc(centerX, centerY, 5, 0, 2*Math.PI);
      ctx.fillStyle = '#000';
      ctx.fill();
    }

    // Asignar gerente y bloquear edición del campo Proyecto
function assignManager() {
  const projectInput = document.getElementById('project');
  const managerInput = document.getElementById('manager');
  const val = projectInput.value;
  
  console.log(`🎯 assignManager llamado con proyecto: "${val}"`);
  console.log(`📋 userProjects disponibles:`, userProjects);
  console.log(`🗺️ projectSaiMap actual:`, projectSaiMap);

  if (userProjects.includes(val)) {
    selectedProject = val;
    managerInput.value = projectManagerMap[val] || '';
    projectInput.readOnly = true; // Bloquea edición después de seleccionar

    console.log(`✅ Proyecto seleccionado: ${selectedProject}`);
    console.log(`👤 Gerente asignado: ${projectManagerMap[val] || 'SIN ASIGNACION'}`);
    console.log(`🔍 Cargando historial de calificaciones...`);

    loadLastScores();
    createSections();
    window.ctx = document.getElementById('gauge').getContext('2d');
    
    updateTotal();
    document.getElementById('date').value = getTodayMx();
  } else {
    console.log(`❌ Proyecto "${val}" no encontrado en userProjects`);
    managerInput.value = '';
    selectedProject = '';
  }
}


    // Obtener fecha de hoy en zona América/Mexico_City (sin usar librerías externas)
    function getTodayMx() {
      // Offset UTC-6, pero maneja horario de verano (aprox 1er domingo de abril a último de octubre)
      const now = new Date();
      // Forzar uso horario "America/Mexico_City"
      const mx = new Date(now.toLocaleString('en-US', { timeZone: 'America/Mexico_City' }));
      return mx.toISOString().slice(0, 10);
    }

 

    // --- Manejo de calificaciones ---
    async function saveScore() {
      if (!selectedProject) return alert("Selecciona primero un proyecto válido.");
      const fecha = document.getElementById('date').value;
      if (!fecha) return alert("Selecciona una fecha válida.");

      // Staff metrics
      const plantillaInicial = parseInt(document.getElementById('plantillaInicial').value) || 0;
      const altas = parseInt(document.getElementById('altas').value) || 0;
      const bajas = parseInt(document.getElementById('bajas').value) || 0;
      const rotacion = bajas > 0 ? (bajas / plantillaInicial) * 100 : 0;

      // Performance metrics
      let totalItems = 0;
      let itemsCumplidos = 0;
      let incidenciasCriticas = 0;
      let quejas = 0;

      // Recolecta respuestas y calcula métricas
      const scoreObj = {
        date: fecha,
        user: currentUser.email,
        at: Timestamp.now(),
        staff: {
          inicial: plantillaInicial,
          altas: altas,
          bajas: bajas,
          rotacion: rotacion.toFixed(2)
        },
        metrics: {}
      };

      let calif = {};
      items.forEach((l, i) => {
        if (!l.startsWith('--')) {
          const num = i + 1;
          const ok = document.querySelector(`input[name="ok${num}"]:checked`);
          const coment = document.querySelector(`[name="coment${num}"], [name="tickets${num}"]`);
          
          if (ok) {
            totalItems++;
            if (ok.value === 'Sí' || ok.value === 'No Aplica') itemsCumplidos++;
            if (negativeLabels.some(rx => rx.test(l)) && ok.value === 'Sí') {
              incidenciasCriticas++;
            }
          }

          calif[num] = {
            label: l,
            result: ok ? ok.value : "",
            comment: coment ? coment.value.trim() : ""
          };

          // Contar quejas si es el ítem correspondiente
          if (l === 'Número de quejas recibidas en estos 30 días?') {
            quejas = parseInt(coment?.value || '0') || 0;
          }
        }
      });

      // Calcular métricas finales
      const tasaCumplimiento = totalItems > 0 ? (itemsCumplidos / totalItems) * 100 : 0;
      const lamparasTotal = parseInt(document.getElementById('lamps-total').value) || 0;
      const lamparasFundidas = parseInt(document.getElementById('lamps-fundidas').value) || 0;
      const porcentajeLamparas = lamparasTotal > 0 ? (lamparasFundidas / lamparasTotal) * 100 : 0;

      scoreObj.metrics = {
        tasaCumplimiento: tasaCumplimiento.toFixed(2),
        incidenciasCriticas,
        lamparasFundidas: porcentajeLamparas.toFixed(2),
        quejas
      };

      scoreObj.answers = calif;
      scoreObj.total = parseFloat(document.getElementById("totalValue").textContent) || 0;

      // Guardar en Firestore usando el nombre SAI correspondiente
      const projectSaiName = projectSaiMap[selectedProject] || selectedProject;
      console.log(`Guardando calificación para proyecto: ${selectedProject} -> SAI: ${projectSaiName}`);
      
      const ref = doc(db, "project_scores", projectSaiName);
      const snap = await getDoc(ref);
      let arr = [];
      if (snap.exists() && Array.isArray(snap.data().scores)) {
        arr = snap.data().scores;
      }
      
      // Agregar información adicional al score
      scoreObj.checklistProject = selectedProject; // Nombre original del checklist
      scoreObj.saiProject = projectSaiName; // Nombre en SAI
      
      arr.unshift(scoreObj);
      if (arr.length > 12) arr = arr.slice(0, 12);
      await setDoc(ref, { scores: arr }, { merge: true });
      alert(`Calificación guardada para ${selectedProject} (${projectSaiName}).`);
      loadLastScores();

      // Actualizar displays de métricas
      document.getElementById('rotacionValue').textContent = rotacion.toFixed(2) + '%';
      document.getElementById('tasaCumplimiento').textContent = tasaCumplimiento.toFixed(2) + '%';
      document.getElementById('incidenciasCriticas').textContent = incidenciasCriticas;
      document.getElementById('lamparasFundidas').textContent = porcentajeLamparas.toFixed(2) + '%';
      document.getElementById('totalQuejas').textContent = quejas;
    }

    // Mostrar las últimas 12 calificaciones guardadas (por proyecto)
    async function loadLastScores() {
      console.log(`🔍 loadLastScores iniciado para selectedProject: "${selectedProject}"`);
      console.log(`🗺️ projectSaiMap disponible:`, projectSaiMap);
      
      const box = document.getElementById("lastScores");
      if (!box) {
        console.error(`❌ Elemento #lastScores no encontrado`);
        return;
      }
      
      box.innerHTML = '<b>Últimas 12 calificaciones de este proyecto:</b>';
      if (!selectedProject) {
        console.log(`❌ No hay selectedProject`);
        return;
      }
      
      // Usar el nombre SAI para buscar las calificaciones (igual que en saveScore)
      const projectSaiName = projectSaiMap[selectedProject] || selectedProject;
      console.log(`🔍 Cargando historial para: ${selectedProject} -> SAI: ${projectSaiName}`);
      
      const ref = doc(db, "project_scores", projectSaiName);
      console.log(`📊 Consultando Firebase: project_scores/${projectSaiName}`);
      
      try {
        const snap = await getDoc(ref);
        console.log(`📄 Documento existe:`, snap.exists());
        
        if (!snap.exists()) {
          box.innerHTML += `<br><i>No hay registros previos para ${selectedProject} (${projectSaiName}).</i>`;
          console.log(`❌ Documento no existe para ${projectSaiName}`);
          return;
        }
        
        const data = snap.data();
        console.log(`📋 Datos del documento:`, data);
        
        if (!data.scores || !Array.isArray(data.scores)) {
          box.innerHTML += `<br><i>No hay scores guardados para ${selectedProject} (${projectSaiName}).</i>`;
          console.log(`❌ No hay array de scores en el documento`);
          return;
        }
        
        console.log(`✅ Encontrados ${data.scores.length} registros para ${projectSaiName}`);
        
        const arr = data.scores;
        box.innerHTML += `
          <table style="margin-top:10px;width:100%;font-size:.95em">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Usuario</th>
                <th>Calificación</th>
                <th>Detalle</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(s => `
                <tr>
                  <td>${(s.date||"").toString().slice(0,10)}</td>
                  <td>${s.user||""}</td>
                  <td>${(s.total||0).toFixed(2)}%</td>
                  <td>
                    <button onclick='window.showScoreDetail(${JSON.stringify(s)})'>Ver</button>
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
        
        console.log(`✅ Tabla de historial generada exitosamente`);
        
      } catch (error) {
        console.error(`💥 Error al cargar historial:`, error);
        box.innerHTML += `<br><i>Error al cargar registros: ${error.message}</i>`;
      }
    }
    
    // Ventana detalle para ver calificación completa
    window.showScoreDetail = function(scoreObj) {
      let w = window.open("", "_blank", "width=800,height=600");
      w.document.write("<h2>Detalle de calificación</h2>");
      w.document.write(`<b>Fecha:</b> ${scoreObj.date || ""}<br><b>Usuario:</b> ${scoreObj.user || ""}<br><b>Calificación:</b> ${(scoreObj.total||0).toFixed(2)}%<hr>`);
      for (let n in scoreObj.answers) {
        let ans = scoreObj.answers[n];
        w.document.write(`<b>${ans.label}:</b> ${ans.result || "-"}<br><i>${ans.comment || ""}</i><hr>`);
      }
    }

window.addEventListener('DOMContentLoaded', () => {
  // Inicializa la fecha de México Central
  document.getElementById('date').value = getTodayMx();

  // Listener para seleccionar proyecto y buscar
  document.getElementById('project').addEventListener('change', assignManager);
  document.getElementById('searchBtn').addEventListener('click', (e) => {
    e.preventDefault();
    assignManager();
 

  });
    // Listener para Cerrar Sesión
  document.getElementById('logoutBtn')
    .addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = "login.html";
      } catch (err) {
        console.error("Error cerrando sesión:", err);
        alert("No se pudo cerrar sesión. Intenta de nuevo.");
      }
    });

  // SOLO CREA el botón de guardar si no existe
  if (!document.getElementById('btn-guardar-calif')) {
    const btn = document.createElement("button");
    btn.id = 'btn-guardar-calif';
    btn.textContent = "Guardar calificación";
    btn.style.marginTop = "30px";
    btn.style.background = "var(--primary)";
    btn.style.color = "#fff";
    btn.style.fontWeight = "bold";
    btn.onclick = saveScore;
    document.querySelector(".card").appendChild(btn);
  }

  // === INICIALIZA EL CONTEXTO DEL GAUGE SOLO UNA VEZ ===
  const gaugeCanvas = document.getElementById('gauge');
  if (gaugeCanvas && gaugeCanvas.getContext && !window.ctx) {
    window.ctx = gaugeCanvas.getContext('2d');
  }

  // ✅ CORREGIDO: Inicializar gauge con valor 0 sin dependencias
  drawGauge(0);
});


  // Sonido por tecla presionada en todos los inputs y textarea
  const keySound = document.getElementById("keySound");

  function playKeySound() {
    keySound.currentTime = 0;
    keySound.play();
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Sonido al escribir en cualquier input o textarea
    document.querySelectorAll('input, textarea').forEach(el => {
      el.addEventListener("keydown", e => {
        if (e.key.length === 1 || e.key === "Backspace" || e.key === "Delete") {
          playKeySound();
        }
      });
    });
    // Sonido por click en cualquier botón
    document.querySelectorAll('button').forEach(btn => {
      btn.addEventListener("click", playKeySound);
    });

    // Sonido por click en radios de Sí, No, No Aplica (incluye los generados dinámicamente)
    document.body.addEventListener("change", function(e) {
      if (
        e.target.matches('input[type="radio"][name^="ok"]')
      ) {
        playKeySound();
      }
    });

    // Sonido al escribir en comentarios dinámicos (textarea dentro de la tabla)
    document.body.addEventListener("keydown", function(e) {
      if (
        e.target.matches('textarea[name^="coment"], textarea[name^="tickets"]') &&
        (e.key.length === 1 || e.key === "Backspace" || e.key === "Delete")
      ) {
        playKeySound();
      }
    });
  });

  // Redirección por click en logo según usuario autenticado
    document.addEventListener("DOMContentLoaded", () => {
      const logo = document.getElementById("logo-accessone");
      if (logo) {
        logo.onclick = (e) => {
          e.preventDefault();
          const email = (currentUser?.email || "").toLowerCase();
          if (
            email === "csalcala@accessone.com.mx" ||
            email === "valonzo@accessone.com.mx" ||
            email === "jfernandez@accessone.com.mx"
          ) {
            window.location.href = "login-admin.html";
          } else {
            window.location.href = "index.html";
          }
        };
      }
    });
  </script>
</body>
  <script src="./js/logo-fix.js"></script>
</html>
